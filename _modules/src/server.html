
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>src.server &#8212; Spireblight 0.7 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=48f8e935"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/src/server';</script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Spireblight 0.7 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro.html">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../owners.html">
    For bot owners
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    Full Spireblight API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Spireblight/Spireblight" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro.html">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../owners.html">
    For bot owners
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    Full Spireblight API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Spireblight/Spireblight" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">src.server</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for src.server</h1><div class="highlight"><pre>
<span></span><span class="c1"># (c) Anilyka Barry, 2022-2024</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">twitchio.ext.commands</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Cooldown</span> <span class="k">as</span> <span class="n">TCooldown</span><span class="p">,</span>
    <span class="n">Bucket</span> <span class="k">as</span> <span class="n">TBucket</span><span class="p">,</span>
    <span class="n">Bot</span> <span class="k">as</span> <span class="n">TBot</span><span class="p">,</span>
    <span class="n">Context</span> <span class="k">as</span> <span class="n">TContext</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twitchio.ext.routines</span><span class="w"> </span><span class="kn">import</span> <span class="n">routine</span><span class="p">,</span> <span class="n">Routine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twitchio.ext.eventsub</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventSubClient</span><span class="p">,</span> <span class="n">StreamOnlineData</span><span class="p">,</span> <span class="n">StreamOfflineData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twitchio.channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Channel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twitchio.chatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twitchio.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twitchio.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">Prediction</span><span class="p">,</span> <span class="n">Clip</span> <span class="k">as</span> <span class="n">TClip</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">discord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">discord.ext.commands</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Cooldown</span> <span class="k">as</span> <span class="n">DCooldown</span><span class="p">,</span>
    <span class="n">BucketType</span> <span class="k">as</span> <span class="n">DBucket</span><span class="p">,</span>
    <span class="n">Bot</span> <span class="k">as</span> <span class="n">DBot</span><span class="p">,</span>
    <span class="n">command</span> <span class="k">as</span> <span class="n">_dcommand</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp_jinja2</span><span class="w"> </span><span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp.web</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPNotFound</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">HTTPServiceUnavailable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientSession</span><span class="p">,</span> <span class="n">ContentTypeError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.cache.run_stats</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_all_run_stats</span><span class="p">,</span>
    <span class="n">get_run_stats_by_date</span><span class="p">,</span>
    <span class="n">get_run_stats_by_date_string</span><span class="p">,</span>
    <span class="n">update_range</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.cache.mastered</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_masteries</span><span class="p">,</span> <span class="n">get_mastered</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.nameinternal</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">sanitize</span><span class="p">,</span> <span class="n">Base</span><span class="p">,</span> <span class="n">Card</span><span class="p">,</span> <span class="n">Relic</span><span class="p">,</span> <span class="n">RelicSet</span><span class="p">,</span> <span class="n">_internal_cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.sts_profile</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_profile</span><span class="p">,</span> <span class="n">get_current_profile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.webpage</span><span class="w"> </span><span class="kn">import</span> <span class="n">router</span><span class="p">,</span> <span class="n">playlists</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.wrapper</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.monster</span><span class="w"> </span><span class="kn">import</span> <span class="n">query</span> <span class="k">as</span> <span class="n">mt_query</span><span class="p">,</span> <span class="n">get_savefile</span> <span class="k">as</span> <span class="n">get_mt_save</span><span class="p">,</span> <span class="n">MonsterSave</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.twitch</span><span class="w"> </span><span class="kn">import</span> <span class="n">TwitchCommand</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.events</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_listener</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">__botname__</span><span class="p">,</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">__github__</span><span class="p">,</span> <span class="n">__author__</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.slice</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_runs</span><span class="p">,</span> <span class="n">CurrentRun</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">format_for_slaytabase</span><span class="p">,</span>
    <span class="n">getfile</span><span class="p">,</span>
    <span class="n">parse_date_range</span><span class="p">,</span>
    <span class="n">update_db</span><span class="p">,</span>
    <span class="n">get_req_data</span><span class="p">,</span>
    <span class="n">post_prediction</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.disc</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiscordCommand</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.save</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_savefile</span><span class="p">,</span> <span class="n">Savefile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.runs</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_latest_run</span><span class="p">,</span> <span class="n">get_parser</span><span class="p">,</span> <span class="n">_ts_cache</span> <span class="k">as</span> <span class="n">_runs_cache</span><span class="p">,</span> <span class="n">RunParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.gamedata</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelicData</span><span class="p">,</span> <span class="n">Treasure</span><span class="p">,</span> <span class="n">Event</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.typehints</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">CommandType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src</span><span class="w"> </span><span class="kn">import</span> <span class="n">events</span><span class="p">,</span> <span class="n">archive</span>

<span class="n">TConn</span><span class="p">:</span> <span class="n">TwitchConn</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">DConn</span><span class="p">:</span> <span class="n">DiscordConn</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up&quot;</span><span class="p">)</span>

<span class="c1"># Twitch bot server defined here - process started in main.py</span>

<span class="n">_DEFAULT_BURST</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">_DEFAULT_RATE</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="n">_consts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;discord&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">discord</span><span class="o">.</span><span class="n">invite_links</span><span class="o">.</span><span class="n">main</span><span class="p">,</span>
    <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
    <span class="s2">&quot;website&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_quotes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Quote</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">_clips</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Clip</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="c1"># means un-itialized</span>


<div class="viewcode-block" id="Formatter">
<a class="viewcode-back" href="../../server.html#src.server.Formatter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Formatter</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>  <span class="c1"># this does not support conversion or formatting</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+(\(.+\)).*&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Formatter.parse">
<a class="viewcode-back" href="../../server.html#src.server.Formatter.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">format_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># recursion</span>
            <span class="k">yield</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">format_string</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">format_string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;$&lt;&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">format_string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="n">start</span><span class="p">:],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">lit</span> <span class="o">=</span> <span class="n">format_string</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">field</span> <span class="o">=</span> <span class="n">format_string</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">end</span><span class="p">]</span>

            <span class="n">called</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">call_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">call_args</span><span class="p">:</span>
                <span class="n">called</span> <span class="o">=</span> <span class="n">call_args</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">call_idx</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">called</span><span class="p">)</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:</span><span class="n">call_idx</span><span class="p">]</span>
                <span class="n">called</span> <span class="o">=</span> <span class="n">called</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">yield</span> <span class="p">(</span><span class="n">lit</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">called</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Formatter.format_field">
<a class="viewcode-back" href="../../server.html#src.server.Formatter.format_field">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">call_args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">call_args</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">(</span><span class="n">call_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>
</div>



<span class="n">_formatter</span> <span class="o">=</span> <span class="n">Formatter</span><span class="p">()</span>

<span class="n">_perms</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="s2">&quot;Everyone&quot;</span><span class="p">,</span>
    <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="s2">&quot;Moderator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;Editor&quot;</span><span class="p">,</span>  <span class="c1"># this has no effect in discord</span>
<span class="p">}</span>

<span class="n">_cmds</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># internal json</span>

<span class="n">_to_add_twitch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TwitchCommand</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">_to_add_discord</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DiscordCommand</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">_timers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Timer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">_prediction_terms</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_sanitizer</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize</span><span class="p">(</span><span class="n">require_args</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">in_mapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that user input is sane. Return True if input is sane.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">require_args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: no output provided.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">in_mapping</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_mapping</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">_sanitize</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_create_cmd</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># we expect something to increase or decrease</span>
        <span class="c1"># but if it&#39;s invalid, just return existing count</span>
        <span class="c1"># we don&#39;t want text commands to fail for no reason</span>
        <span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">match</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;increase&quot;</span> <span class="o">|</span> <span class="s2">&quot;++&quot;</span><span class="p">:</span>
                <span class="n">inner</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">case</span> <span class="s2">&quot;decrease&quot;</span> <span class="o">|</span> <span class="s2">&quot;--&quot;</span><span class="p">:</span>
                <span class="n">inner</span><span class="o">.</span><span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">count</span>
            <span class="n">update_db</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">inner</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">output</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">words</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">_consts</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: command has unsupported formatting key </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mt-save&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;savefile&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;profile&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;readline&quot;</span><span class="p">:</span> <span class="n">readline</span><span class="p">,</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;$&lt;profile&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">get_current_profile</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">profile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: command requires an existing profile, and none exist.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="k">if</span> <span class="s2">&quot;$&lt;savefile&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;savefile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_savefile</span><span class="p">()</span>
            <span class="c1"># No save file found:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;savefile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">in_game</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Not in a run.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="s2">&quot;$&lt;mt-save&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;mt-save&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_mt_save</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;mt-save&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_formatter</span><span class="o">.</span><span class="n">vformat</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(),</span> <span class="n">keywords</span><span class="p">)</span>
        <span class="c1"># TODO: Add a flag to the command that says whether it&#39;s a reply</span>
        <span class="c1"># or a regular message.</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">inner</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">inner</span>


<div class="viewcode-block" id="readline">
<a class="viewcode-back" href="../../server.html#src.server.readline">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">readline</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;..&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Error: &#39;..&#39; in filename is not allowed.&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span></div>



<div class="viewcode-block" id="load">
<a class="viewcode-back" href="../../server.html#src.server.load">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">):</span>
    <span class="n">_cmds</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;data.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">_cmds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">command</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="o">*</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">flag</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">burst</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;burst&quot;</span><span class="p">,</span> <span class="n">_DEFAULT_BURST</span><span class="p">),</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="n">_DEFAULT_RATE</span><span class="p">),</span>
        <span class="p">)(</span><span class="n">_create_cmd</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">disabled</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">pass</span>
                <span class="c1"># TConn.commands[disabled].enabled = False</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">_prediction_terms</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;prediction_terms.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">_prediction_terms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">to_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;timers.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">],</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
            <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">to_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_launch_timers</span><span class="p">(</span><span class="n">to_start</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;quotes.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">adder</span><span class="p">,</span> <span class="n">isq</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">Quote</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">adder</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isq</span><span class="p">:</span>
                <span class="n">q</span><span class="o">.</span><span class="n">is_quote</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">_quotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_update_quotes</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_quotes</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;quotes.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">json_indent</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_launch_timers</span><span class="p">(</span><span class="n">timers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Timer</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="n">timers</span><span class="p">:</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">stagger_interval</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_update_timers</span><span class="p">():</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">timer</span> <span class="ow">in</span> <span class="n">_timers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="n">timer</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="n">timer</span><span class="o">.</span><span class="n">commands</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timer</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">final</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;timers.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">json_indent</span><span class="p">)</span>


<span class="c1"># Adds non built-in commands to internal json structure</span>
<div class="viewcode-block" id="add_cmd">
<a class="viewcode-back" href="../../server.html#src.server.add_cmd">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_cmd</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">burst</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">aliases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aliases</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
    <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag</span>
    <span class="k">if</span> <span class="n">burst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;burst&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">burst</span>
    <span class="k">if</span> <span class="n">rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
    <span class="n">update_db</span><span class="p">()</span></div>



<div class="viewcode-block" id="command">
<a class="viewcode-back" href="../../server.html#src.server.command">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">command</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="n">aliases</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">force_argcount</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">burst</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_DEFAULT_BURST</span><span class="p">,</span>
    <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_DEFAULT_RATE</span><span class="p">,</span>
    <span class="n">twitch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">discord</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This decorator builds TwitchCommand and DiscordCommand versions of commands while leaving the original functions untouched.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">wrapper_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">force_argcount</span><span class="p">,</span> <span class="n">wrapper_func</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">wrapped</span><span class="o">.</span><span class="n">__cooldowns__</span> <span class="o">=</span> <span class="p">[</span><span class="n">TCooldown</span><span class="p">(</span><span class="n">burst</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">TBucket</span><span class="o">.</span><span class="n">default</span><span class="p">)]</span>
        <span class="n">wrapped</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="c1"># wrapped.__commands_cooldown__ = DCooldown(burst, rate, DBucket.default)</span>
        <span class="k">if</span> <span class="n">twitch</span><span class="p">:</span>
            <span class="n">tcmd</span> <span class="o">=</span> <span class="n">TwitchCommand</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">aliases</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_to_add_twitch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tcmd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">TConn</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">tcmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">discord</span><span class="p">:</span>
            <span class="n">dcmd</span> <span class="o">=</span> <span class="n">_dcommand</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">DiscordCommand</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">aliases</span><span class="p">),</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">)(</span>
                <span class="n">wrapped</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_to_add_discord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcmd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">DConn</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">dcmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">inner</span></div>



<div class="viewcode-block" id="with_savefile">
<a class="viewcode-back" href="../../server.html#src.server.with_savefile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">with_savefile</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">optional_save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for commands that require a save.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_savefile_get</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">get_savefile</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No savefile&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">character</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">optional_save</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Not in a run.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not in a run&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">character</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">optional_save</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)(</span><span class="n">func</span><span class="p">,</span> <span class="n">wrapper_func</span><span class="o">=</span><span class="n">_savefile_get</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span></div>



<div class="viewcode-block" id="slice_command">
<a class="viewcode-back" href="../../server.html#src.server.slice_command">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">slice_command</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_slice_get</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">get_runs</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We are not playing Slice &amp; Dice currently.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No Slice &amp; Dice run going on&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;classic&quot;</span><span class="p">]]</span>  <span class="c1"># FIXME: Does not support multiple S&amp;D runs at once</span>

        <span class="k">return</span> <span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)(</span><span class="n">func</span><span class="p">,</span> <span class="n">wrapper_func</span><span class="o">=</span><span class="n">_slice_get</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span></div>



<div class="viewcode-block" id="mt_command">
<a class="viewcode-back" href="../../server.html#src.server.mt_command">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mt_command</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_mt_get</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_mt_save</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No savefile&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)(</span><span class="n">func</span><span class="p">,</span> <span class="n">wrapper_func</span><span class="o">=</span><span class="n">_mt_get</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span></div>



<div class="viewcode-block" id="TwitchConn">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TwitchConn</span><span class="p">(</span><span class="n">TBot</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esclient</span><span class="p">:</span> <span class="n">EventSubClient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">live_channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">:</span> <span class="n">AppClient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span> <span class="n">ClientSession</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expires_at</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_refresh_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;spotify_refresh_token&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_refresh_token</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="TwitchConn.refresh_spotify_token">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.refresh_spotify_token">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_spotify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">spotify</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">spotify</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">spotify</span><span class="o">.</span><span class="n">secret</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Basic </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_refresh_token</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span>
                <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_refresh_token</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">spotify</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/spotify&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;https://accounts.spotify.com/api/token&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_token</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expires_at</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">])</span>
                <span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;refresh_token&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_refresh_token</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;spotify_refresh_token&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span>
                        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spotify_refresh_token</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1"># oh no</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not write refresh token to file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_spotify_refresh_token</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_token</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TwitchConn.spotify_call">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.spotify_call">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">spotify_call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">spotify</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spotify_token</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires_at</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="n">token</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_spotify_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;https://api.spotify.com/v1/me/player/currently-playing&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_spotify_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">ContentTypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="TwitchConn.eventsub_setup">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.eventsub_setup">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">eventsub_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esclient</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">4000</span><span class="p">))</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_users</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">esclient</span><span class="o">.</span><span class="n">subscribe_channel_stream_start</span><span class="p">(</span><span class="n">broadcaster</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">esclient</span><span class="o">.</span><span class="n">subscribe_channel_stream_end</span><span class="p">(</span><span class="n">broadcaster</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="TwitchConn.event_ready">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.event_ready">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">live_channels</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">live</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_streams</span><span class="p">(</span><span class="n">user_logins</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">])</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TwitchConn.event_raw_usernotice">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.event_raw_usernotice">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_raw_usernotice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">Chatter</span><span class="p">(</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">tags</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">],</span>
            <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
            <span class="n">bot</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">websocket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">match</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;msg-id&quot;</span><span class="p">]:</span>
            <span class="k">case</span> <span class="s2">&quot;sub&quot;</span> <span class="o">|</span> <span class="s2">&quot;resub&quot;</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">consecutive</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">subtype</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s2">&quot;msg-param-cumulative-months&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s2">&quot;msg-param-should-share-streak&quot;</span><span class="p">]):</span>
                        <span class="n">consecutive</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s2">&quot;msg-param-streak-months&quot;</span><span class="p">])</span>
                    <span class="n">subtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;msg-param-sub-plan&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">subtype</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">subtype</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tier </span><span class="si">{</span><span class="n">subtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_event</span><span class="p">(</span>
                    <span class="s2">&quot;subscription&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">consecutive</span><span class="p">,</span> <span class="n">subtype</span>
                <span class="p">)</span>
            <span class="k">case</span> <span class="p">(</span>
                <span class="s2">&quot;subgift&quot;</span>
                <span class="o">|</span> <span class="s2">&quot;anonsubgift&quot;</span>
                <span class="o">|</span> <span class="s2">&quot;submysterygift&quot;</span>
                <span class="o">|</span> <span class="s2">&quot;giftpaidupgrade&quot;</span>
                <span class="o">|</span> <span class="s2">&quot;rewardgift&quot;</span>
                <span class="o">|</span> <span class="s2">&quot;anongiftpaidupgrade&quot;</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_event</span><span class="p">(</span><span class="s2">&quot;gift_sub&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;raid&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_event</span><span class="p">(</span>
                    <span class="s2">&quot;raid&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s2">&quot;msg-param-viewerCount&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;unraid&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_event</span><span class="p">(</span><span class="s2">&quot;unraid&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;ritual&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_event</span><span class="p">(</span><span class="s2">&quot;ritual&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;bitsbadgetier&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_event</span><span class="p">(</span><span class="s2">&quot;bits_badge&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span></div>


<div class="viewcode-block" id="TwitchConn.event_subscription">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.event_subscription">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_subscription</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Chatter</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
        <span class="n">total</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">consecutive</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="TwitchConn.event_ritual">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.event_ritual">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_ritual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">Chatter</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;msg-param-ritual-name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;new_chatter&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_event</span><span class="p">(</span><span class="s2">&quot;new_chatter&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TwitchConn.event_new_chatter">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.event_new_chatter">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_new_chatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">Chatter</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;youtube&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;yt&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">pass</span>  <span class="c1"># await channel.send(f&quot;Hello {user.display_name}! Glad to hear that you&#39;re enjoying the YouTube content, and welcome along baalorLove&quot;)</span></div>


<div class="viewcode-block" id="TwitchConn.event_raid">
<a class="viewcode-back" href="../../server.html#src.server.TwitchConn.event_raid">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_raid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">Chatter</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">viewer_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">viewer_count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">chan</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_channel</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Welcome along </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> with your </span><span class="si">{</span><span class="n">viewer_count</span><span class="si">}</span><span class="s2"> friends! &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Everyone, go give them a follow over at https://twitch.tv/</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;last I checked, they were playing some </span><span class="si">{</span><span class="n">chan</span><span class="o">.</span><span class="n">game_name</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="s2">&quot;event_&quot;</span>
        <span class="p">):</span>  <span class="c1"># calling events -- insert our own event system in</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
            <span class="n">evt</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">evt</span><span class="p">:</span>

                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">evt</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">e</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">invoke</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="AppClient">
<a class="viewcode-back" href="../../server.html#src.server.AppClient">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AppClient</span><span class="p">(</span><span class="n">TBot</span><span class="p">):</span>
<div class="viewcode-block" id="AppClient.event_token_expired">
<a class="viewcode-back" href="../../server.html#src.server.AppClient.event_token_expired">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_token_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># shamelessly stolen from TwitchIO with one change</span>
        <span class="n">reft</span> <span class="o">=</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-refresh&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;https://id.twitch.tv/oauth2/token?grant_type=refresh_token&amp;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;refresh_token=</span><span class="si">{</span><span class="n">reft</span><span class="si">}</span><span class="s2">&amp;client_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">client_id</span><span class="si">}</span><span class="s2">&amp;client_secret=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">client_secret</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">300</span> <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to generate a token: &quot;</span> <span class="o">+</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
            <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Invalid or no token found, generated new token: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-oauth&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-refresh&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>
</div>



<div class="viewcode-block" id="EventSubBot">
<a class="viewcode-back" href="../../server.html#src.server.EventSubBot">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EventSubBot</span><span class="p">(</span><span class="n">TBot</span><span class="p">):</span>
<div class="viewcode-block" id="EventSubBot.event_eventsub_notification_stream_start">
<a class="viewcode-back" href="../../server.html#src.server.EventSubBot.event_eventsub_notification_stream_start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_eventsub_notification_stream_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">:</span> <span class="n">StreamOnlineData</span><span class="p">):</span>
        <span class="n">TConn</span><span class="o">.</span><span class="n">live_channels</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">broadcaster</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="EventSubBot.event_eventsub_notification_stream_end">
<a class="viewcode-back" href="../../server.html#src.server.EventSubBot.event_eventsub_notification_stream_end">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_eventsub_notification_stream_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">:</span> <span class="n">StreamOfflineData</span><span class="p">):</span>
        <span class="n">TConn</span><span class="o">.</span><span class="n">live_channels</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">broadcaster</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="DiscordConn">
<a class="viewcode-back" href="../../server.html#src.server.DiscordConn">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DiscordConn</span><span class="p">(</span><span class="n">DBot</span><span class="p">):</span>
<div class="viewcode-block" id="DiscordConn.on_message">
<a class="viewcode-back" href="../../server.html#src.server.DiscordConn.on_message">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">message</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">DMChannel</span>
        <span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">cmd</span><span class="p">:</span> <span class="n">DiscordCommand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span></div>


<div class="viewcode-block" id="DiscordConn.dispatch">
<a class="viewcode-back" href="../../server.html#src.server.DiscordConn.dispatch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">evt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">evt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">evt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">evt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_listener</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>
</div>



<div class="viewcode-block" id="Timer">
<a class="viewcode-back" href="../../server.html#src.server.Timer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Timer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_routine</span><span class="p">()</span>

<div class="viewcode-block" id="Timer.set_routine">
<a class="viewcode-back" href="../../server.html#src.server.Timer.set_routine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_routine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_routine</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_routine</span> <span class="o">=</span> <span class="n">Routine</span><span class="p">(</span>
            <span class="n">coro</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_coro_internal</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">),</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_routine</span><span class="o">.</span><span class="n">before_routine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">before_ready</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_routine</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_error</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routine</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_coro_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">live</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_streams</span><span class="p">(</span><span class="n">user_logins</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">])</span>
        <span class="n">chan</span> <span class="o">=</span> <span class="n">TConn</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">live</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">chan</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;auto_&quot;</span><span class="p">):</span> <span class="c1"># stream ended, kill this timer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">_timers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">_update_timers</span><span class="p">()</span>
                <span class="c1"># XXX: This is now the only reference of itself</span>
                <span class="c1"># It should get GC&#39;d properly, but might have issues</span>
            <span class="k">return</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="n">maybe_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maybe_cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span> <span class="ow">and</span> <span class="n">maybe_cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TConn</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># we&#39;re not adding it back, so it&#39;s fine</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">TConn</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">maybe_cmd</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maybe_cmd</span><span class="p">)</span>  <span class="c1"># in case it gets enabled again</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">maybe_cmd</span> <span class="o">==</span> <span class="s2">&quot;current&quot;</span><span class="p">:</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">get_savefile</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">save</span><span class="o">.</span><span class="n">in_game</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maybe_cmd</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">maybe_cmd</span>
        <span class="c1"># don&#39;t use the actual command, just send the raw output</span>
        <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_cmds</span><span class="p">[</span><span class="n">cmd</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_consts</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> of timer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> needs non-constant formatting. Sending raw line.&quot;</span>
            <span class="p">)</span>
        <span class="k">await</span> <span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">_update_timers</span><span class="p">()</span>  <span class="c1"># keep track of command ordering</span>

<div class="viewcode-block" id="Timer.before_ready">
<a class="viewcode-back" href="../../server.html#src.server.Timer.before_ready">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">before_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">wait_for_ready</span><span class="p">()</span></div>


<div class="viewcode-block" id="Timer.on_error">
<a class="viewcode-back" href="../../server.html#src.server.Timer.on_error">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in timer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="n">error</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Timer.start">
<a class="viewcode-back" href="../../server.html#src.server.Timer.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routine</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="Timer.stop">
<a class="viewcode-back" href="../../server.html#src.server.Timer.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_routine</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="timers_list">
<a class="viewcode-back" href="../../server.html#src.server.timers_list">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;timers&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;me&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">timers_list</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The existing timers are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_timers</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="timer_cmd">
<a class="viewcode-back" href="../../server.html#src.server.timer_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;timer&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;me&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">timer_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manipulate the timers. Syntax:</span>

<span class="sd">    - `create &lt;name&gt; [interval]`</span>
<span class="sd">       will create a new timer with the name and the given interval,</span>
<span class="sd">       if specified. It has no other effect.</span>
<span class="sd">    - `add &lt;name&gt; &lt;commands&gt;`</span>
<span class="sd">       will add all of the commands (space-separated) to the timer `name` -</span>
<span class="sd">       it does not start the timer. If it is running, it will seamlessly</span>
<span class="sd">       integrate the new command at the current point in the rotation.</span>
<span class="sd">    - `remove &lt;name&gt; &lt;commands&gt;`</span>
<span class="sd">       will remove all of the commands (space-separated) to the timer `name` -</span>
<span class="sd">       it does not stop or delete the timer.</span>
<span class="sd">    - `delete &lt;name&gt;` completely removes a timer and associated commands.</span>
<span class="sd">       This cannot be undone.</span>
<span class="sd">    - `auto &lt;name&gt; [interval]`</span>
<span class="sd">       creates a new timer with the given interval, if specified, and exactly</span>
<span class="sd">       one command `name`. It immediately starts it. This is basically used for</span>
<span class="sd">       single-command sponsored timers and the like. The internal timer name will</span>
<span class="sd">       start with `auto_`, followed by the command name, and can be edited normally</span>
<span class="sd">       afterwards. It will automatically delete itself when the stream ends.</span>
<span class="sd">    - `status &lt;name&gt;`</span>
<span class="sd">       outputs the commands and interval tied to this timer.</span>
<span class="sd">    - `start &lt;name&gt;`</span>
<span class="sd">       starts the given timer.</span>
<span class="sd">    - `stop &lt;name&gt;`</span>
<span class="sd">       stops the given timer.</span>
<span class="sd">    - `interval &lt;name&gt; &lt;interval&gt;`</span>
<span class="sd">       changes the interval of an existing timer. This will have some weird</span>
<span class="sd">       double-send glitch if editing the interval of a running timer, but is</span>
<span class="sd">       mostly fine otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">match</span> <span class="n">action</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;auto_&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot manually create automatic timers. Use &#39;auto </span><span class="si">{</span><span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">default_interval</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been created! Use &#39;add </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> &lt;commands&gt;&#39; to add commands to it.&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t exist. Use &#39;create </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; first.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No commands to add.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">TConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cmd</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> now has commands </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="p">)</span><span class="si">}</span><span class="s2"> on an interval of </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2">s.&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t exist. Use &#39;create </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; first.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No commands to remove.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> now has commands </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="p">)</span><span class="si">}</span><span class="s2"> on an interval of </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2">s.&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t exist. Use &#39;create </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; first.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">t</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been removed.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">TConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">timer_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;auto_</span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">timer_name</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Automatic timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">timer_name</span><span class="si">}</span><span class="s2">) already exists; starting it.&quot;</span>
                <span class="p">)</span>
                <span class="n">_timers</span><span class="p">[</span><span class="n">timer_name</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">default_interval</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_timers</span><span class="p">[</span><span class="n">timer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">timer_name</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Automatic timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">timer_name</span><span class="si">}</span><span class="s2">) has been created and started. It will self-remove after stream.&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;status&quot;</span> <span class="o">|</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has an interval of </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2">s with commands </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">commands</span><span class="p">)</span><span class="si">}</span><span class="s2"> and is currently </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">running</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;stopped&#39;</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is already running.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been started.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not running.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been stopped.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_timers</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_timers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">default_interval</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">t</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_routine</span><span class="p">()</span>
            <span class="n">_update_timers</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been set to interval </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">. If it was running, it will complete the existing interval.&quot;</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="command_cmd">
<a class="viewcode-back" href="../../server.html#src.server.command_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;me&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">command_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Syntax: command &lt;action&gt; &lt;name&gt; [+flag] &lt;output&gt;&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">cmds</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">TConn</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cmds</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">DConn</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                <span class="n">cmds</span><span class="p">[</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cmds</span><span class="p">[</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">TConn</span><span class="o">.</span><span class="n">_command_aliases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dcmd</span> <span class="ow">in</span> <span class="n">DConn</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">dcmd</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                    <span class="n">aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcmd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">sanitizer</span> <span class="o">=</span> <span class="n">_get_sanitizer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cmds</span><span class="p">)</span>
    <span class="k">match</span> <span class="n">action</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="c1"># sanitizer will call ctx.reply() with error message if input is invalid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">sanitizer</span><span class="p">(</span><span class="n">in_mapping</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is an alias to </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">. Use &#39;unalias </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; first.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
                <span class="n">flag</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_perms</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: flag not recognized.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">add_cmd</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_cmd</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">)(</span><span class="n">_create_cmd</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> added! Permission: </span><span class="si">{</span><span class="n">_perms</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;edit&quot;</span><span class="p">:</span>
            <span class="c1"># sanitizer will call ctx.reply() with error message if input is invalid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">sanitizer</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: cannot edit alias. Use &#39;edit </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: cannot edit built-in command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
                <span class="n">flag</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_perms</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: flag not recognized.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag</span>
            <span class="n">update_db</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="n">_create_cmd</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> edited successfully! Permission: </span><span class="si">{</span><span class="n">_perms</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;remove&quot;</span> <span class="o">|</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span>
            <span class="c1"># sanitizer will call ctx.reply() with error message if input is invalid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">sanitizer</span><span class="p">(</span><span class="n">require_args</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: cannot delete alias. Use &#39;remove </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; or &#39;unalias </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: cannot delete built-in command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">del</span> <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">update_db</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">TConn</span><span class="o">.</span><span class="n">remove_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">DConn</span><span class="o">.</span><span class="n">remove_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been deleted.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;enable&quot;</span><span class="p">:</span>
            <span class="c1"># sanitizer will call ctx.reply() with error message if input is invalid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">sanitizer</span><span class="p">(</span><span class="n">require_args</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: cannot enable alias. Use &#39;enable </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is already enabled.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">update_db</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">disabled</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">disabled</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">disabled</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been enabled.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;disable&quot;</span><span class="p">:</span>
            <span class="c1"># sanitizer will call ctx.reply() with error message if input is invalid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">sanitizer</span><span class="p">(</span><span class="n">require_args</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: cannot disable alias. Use &#39;disable </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; or &#39;unalias </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is already disabled.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">update_db</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">disabled</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">disabled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">disabled</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been disabled.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;alias&quot;</span><span class="p">:</span>  <span class="c1"># cannot sanely sanitize this</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alias </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is bound to </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has the following aliases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;aliases&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not have any aliases.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmds</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: use &#39;alias </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: cannot alias built-in commands.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cmds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: aliases </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">cmds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2"> already exist as commands.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">TConn</span><span class="o">.</span><span class="n">_command_aliases</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">DConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;aliases&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">update_db</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> now has aliases </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;aliases&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;unalias&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: no alias specified.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Can only remove one alias at a time.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmds</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: use &#39;unalias </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: not an alias.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: cannot unalias built-in commands.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">aliases</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: alias </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> does not match command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (bound to </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">TConn</span><span class="o">.</span><span class="n">_command_aliases</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dcmd</span><span class="p">:</span> <span class="n">DiscordCommand</span> <span class="o">=</span> <span class="n">DConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dcmd</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
                    <span class="n">dcmd</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">update_db</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alias </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> has been removed from command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;cooldown&quot;</span> <span class="o">|</span> <span class="s2">&quot;cd&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Cooldown cannot be changed currently&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            <span class="c1"># sanitizer will call ctx.reply() with error message if input is invalid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">sanitizer</span><span class="p">(</span><span class="n">require_args</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmds</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">cd</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_cooldowns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has a cooldown of </span><span class="si">{</span><span class="n">cd</span><span class="o">.</span><span class="n">_per</span><span class="o">/</span><span class="n">cd</span><span class="o">.</span><span class="n">_rate</span><span class="si">}</span><span class="s2">s.&quot;</span>
                    <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: cannot edit alias cooldown. Use &#39;cooldown </span><span class="si">{</span><span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">cd</span><span class="p">:</span> <span class="n">TCooldown</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_cooldowns</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">burst</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: invalid argument.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">burst</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">_rate</span>  <span class="c1"># _rate is actually the burst, it&#39;s weird</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">_per</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: invalid argument.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_cooldowns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TCooldown</span><span class="p">(</span><span class="n">burst</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">bucket</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;burst&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">burst</span>
                <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
                <span class="n">update_db</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Command </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> now has a cooldown of </span><span class="si">{</span><span class="n">rate</span><span class="o">/</span><span class="n">burst</span><span class="si">}</span><span class="s2">s.&quot;</span>
            <span class="p">)</span>  <span class="c1"># this isn&#39;t 100% accurate, but close enough</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: settings on built-in commands do not persist past a restart.&quot;</span>
                <span class="p">)</span>

        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized action </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Quote">
<a class="viewcode-back" href="../../server.html#src.server.Quote">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Quote</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">author</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">added_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">author</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">added_by</span> <span class="o">=</span> <span class="n">added_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_quote</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span>

<div class="viewcode-block" id="Quote.to_json">
<a class="viewcode-back" href="../../server.html#src.server.Quote.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">added_by</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_quote</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">]</span></div>
</div>



<div class="viewcode-block" id="get_raw_quotes">
<a class="viewcode-back" href="../../server.html#src.server.get_raw_quotes">[docs]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/quotes/as-json&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_raw_quotes</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;adder&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;is_quote&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">to_json</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="quote_stuff">
<a class="viewcode-back" href="../../server.html#src.server.quote_stuff">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;quote&quot;</span><span class="p">,</span> <span class="s2">&quot;randomquote&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">quote_stuff</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Edit the quote database or pull a specific or random quote.&quot;&quot;&quot;</span>
    <span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
    <span class="k">match</span> <span class="n">arg</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">line</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">author</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot; -- &quot;</span><span class="p">)</span>
                <span class="n">_quotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Quote</span><span class="p">(</span>
                        <span class="n">line</span><span class="p">,</span> <span class="n">author</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quote #</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> successfully added!&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;edit&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Give me a number for the quote to edit.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;You want me to edit what, exactly?&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Replace it with what? Use &#39;delete&#39; to delete.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                    <span class="n">_quotes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;It is done. No one will remember this.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such quote.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;author&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">author</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Invalid input or not enough arguments.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                    <span class="n">_quotes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">author</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                        <span class="s2">&quot;The author of this quote has been properly attributed.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such quote.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;no-adder&quot;</span> <span class="o">|</span> <span class="s2">&quot;noadder&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No argument or not a number.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                    <span class="n">_quotes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">added_by</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Done. No one added this quote.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such quote.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;no-quote&quot;</span> <span class="o">|</span> <span class="s2">&quot;noquote&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No argument or not a number.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                    <span class="n">_quotes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_quote</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;This is no longer a quote.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such quote.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;timestamp&quot;</span> <span class="o">|</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">date</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Need to be all numbers.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">date</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_quotes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Timestamp successfully changed to </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">. You have rewritten history.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such quote.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;delete&quot;</span> <span class="o">|</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Nothing to delete or invalid input.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">_quotes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;This quote is now gone forever.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;I don&#39;t even HAVE that many quotes!&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;search&quot;</span> <span class="o">|</span> <span class="s2">&quot;find&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;You need to search for something!&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">match</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">):</span>
                <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                        <span class="s2">&quot;No quotes match this. Maybe try narrowing it down?&quot;</span>
                    <span class="p">)</span>
                <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">_get_quote</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">case</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>  <span class="c1"># sanity threshold</span>
                        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                            <span class="s2">&quot;Too many quotes match this. Try a narrower search.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The quotes with this text are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">found</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;list&quot;</span> <span class="o">|</span> <span class="s2">&quot;json&quot;</span> <span class="o">|</span> <span class="s2">&quot;db&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_quotes</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;There are no quotes.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You can see (barebones) quotes here: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/quotes/as-json&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_quotes</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;There are no quotes.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">_get_quote</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">case</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;I&#39;m afraid I don&#39;t understand what that means.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_quotes</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">_get_quote</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such quote.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">_update_quotes</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_quote</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">_quotes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">is_quote</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">line</span>
    <span class="n">author</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">author</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">author</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">added_by</span> <span class="o">=</span> <span class="s2">&quot;, on </span><span class="si">{ts}</span><span class="s2">&quot;</span>
    <span class="c1"># Keep that information, but don&#39;t display it for now. maybe later</span>
    <span class="c1"># if q.added_by:</span>
    <span class="c1">#    added_by = f&quot; (Added by {q.added_by} on {{ts}})&quot;</span>
    <span class="n">added_by</span> <span class="o">=</span> <span class="n">added_by</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Quote #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: &quot;</span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">author</span><span class="si">}{</span><span class="n">added_by</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_update_clips</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_clips</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;clips.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">json_indent</span><span class="p">)</span>


<div class="viewcode-block" id="setup_clips">
<a class="viewcode-back" href="../../server.html#src.server.setup_clips">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup_clips</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">_clips</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;already been setup&quot;</span>
    <span class="n">clips</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;clips.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">adder</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">cj</span><span class="p">:</span>
            <span class="n">clips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="n">maps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">adder</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;need Twitch active for this&quot;</span>

    <span class="k">if</span> <span class="n">clips</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_clips</span><span class="p">(</span><span class="n">clips</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># idk</span>

        <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">clips</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">clip</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">_clips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Clip</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="o">*</span><span class="n">maps</span><span class="p">[</span><span class="n">clip</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">_clips</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># remove None, confirm it&#39;s been setup</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Clips got setup twice, somehow&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Clip">
<a class="viewcode-back" href="../../server.html#src.server.Clip">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Clip</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">TClip</span><span class="p">,</span> <span class="n">added_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">added_by</span> <span class="o">=</span> <span class="n">added_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cf_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>

<div class="viewcode-block" id="Clip.to_json">
<a class="viewcode-back" href="../../server.html#src.server.Clip.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">added_by</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_tags</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Clip</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span></div>



<div class="viewcode-block" id="get_clip_info">
<a class="viewcode-back" href="../../server.html#src.server.get_clip_info">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_clip_info</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TClip</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">_clips</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;setup clips first&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;/clip/&quot;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;/clip/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;clips.twitch.tv&quot;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">url</span> <span class="c1"># idk man</span>

    <span class="k">return</span> <span class="p">(</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_clips</span><span class="p">([</span><span class="nb">id</span><span class="p">])</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="clip_cmd">
<a class="viewcode-back" href="../../server.html#src.server.clip_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">clip_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new clip or find a clip.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_clips</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span> <span class="c1"># need to setup</span>
        <span class="k">await</span> <span class="n">setup_clips</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_clips</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;The Twitch API broke, can&#39;t setup clips.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;/clip/&quot;</span> <span class="ow">in</span> <span class="n">arg</span> <span class="ow">or</span> <span class="s2">&quot;clips.twitch.tv&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_clip_info</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;This isn&#39;t a clip (or the Twitch API broke).&quot;</span><span class="p">)</span>
        <span class="n">adder</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">display_name</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">Clip</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">adder</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">_clips</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;That clip exists already!&quot;</span><span class="p">)</span>
        <span class="n">_clips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">_update_clips</span><span class="p">()</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clip </span><span class="si">{</span><span class="n">cl</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="si">!r}</span><span class="s2"> has been added!&quot;</span><span class="p">)</span>

    <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>

    <span class="k">match</span> <span class="n">arg</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;I need a clip number to edit tags.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_clips</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_clips</span><span class="p">)):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such clip.&quot;</span><span class="p">)</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">_clips</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This clip has the tags </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clip</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">discard</span>
                <span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">_update_clips</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Tags have been updated.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_clips</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We have no clips!&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_clips</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clip #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: https://clips.twitch.tv/</span><span class="si">{</span><span class="n">_clips</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;delete&quot;</span> <span class="o">|</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;I need a clip number to delete.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_clips</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_clips</span><span class="p">)):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such clip.&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clip deleted. Enjoy it one last time: https://clips.twitch.tv/</span><span class="si">{</span><span class="n">_clips</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">_clips</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_update_clips</span><span class="p">()</span>

        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_clips</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_clips</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No such clip.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clip #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: https://clips.twitch.tv/</span><span class="si">{</span><span class="n">_clips</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="c1"># searching for a specific clip</span>
            <span class="n">possible</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Clip</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span><span class="p">,)</span> <span class="o">+</span> <span class="n">rest</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_clips</span><span class="p">):</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">matched</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">matched</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                    <span class="n">possible</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>

            <span class="k">match</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">):</span>
                <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No clips match all of those tags.&quot;</span><span class="p">)</span>
                <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clip #</span><span class="si">{</span><span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: https://clips.twitch.tv/</span><span class="si">{</span><span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">case</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The clips that match are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">possible</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Too many clips match. Try adding more keywords to narrow it down?&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="bot_cmd">
<a class="viewcode-back" href="../../server.html#src.server.bot_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;bot&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bot_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Give general information on the bot itself.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;I am </span><span class="si">{</span><span class="n">__botname__</span><span class="si">}</span><span class="s2"> v</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">, made by </span><span class="si">{</span><span class="n">__author__</span><span class="si">}</span><span class="s2">. Thanks to Baalor running a &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;script on his computer, I can access the game&#39;s data for commands like </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">neow and &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">boss, as well as the </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/current page. I am running on Python &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">micro</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;my source code is at </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">github, and you can financially support &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;my continued development with </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">donate&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="help_cmd">
<a class="viewcode-back" href="../../server.html#src.server.help_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">help_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find help on the various commands in the bot.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Welcome to the stream! Website: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> | Current run: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">current | &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Stream overlay: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">str | Useful commands: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">discord </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">mods </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">neow </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">boss &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">stats </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">games </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">youtube </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">winrate | Silly commands: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">the </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">dig </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">lift &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">quote | All commands: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">commands | Specific help: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">help &lt;command&gt; | About this bot: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">bot&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">tcmd</span> <span class="o">=</span> <span class="n">dcmd</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tcmd</span> <span class="o">=</span> <span class="n">TConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dcmd</span> <span class="o">=</span> <span class="n">DConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">tcmd</span> <span class="ow">or</span> <span class="n">dcmd</span>
    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Full information about this command can be viewed at </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/commands/</span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Could not find matching command. You may view all existing commands here: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/commands&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="shoutout">
<a class="viewcode-back" href="../../server.html#src.server.shoutout">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;support&quot;</span><span class="p">,</span> <span class="s2">&quot;shoutout&quot;</span><span class="p">,</span> <span class="s2">&quot;so&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shoutout</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Give a shoutout to a fellow streamer.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">chan</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_channel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Go give a warm follow to https://twitch.tv/</span><span class="si">{</span><span class="n">chan</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">]</span>

    <span class="n">live</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Stream</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_streams</span><span class="p">([</span><span class="n">chan</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">live</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">game</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">game_name</span>
        <span class="n">viewers</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">viewer_count</span>
        <span class="n">started_at</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">started_at</span>
        <span class="c1"># somehow, doing now() - started_at triggers an error due to conflicting timestamps</span>
        <span class="n">td</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
            <span class="n">seconds</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">started_at</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;they are currently live with </span><span class="si">{</span><span class="n">viewers</span><span class="si">}</span><span class="s2"> viewers playing </span><span class="si">{</span><span class="n">game</span><span class="si">}</span><span class="s2">! They have been live for </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">td</span><span class="p">)</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;last time they were live, they were seen playing </span><span class="si">{</span><span class="n">chan</span><span class="o">.</span><span class="n">game_name</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="p">)</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span></div>



<div class="viewcode-block" id="stream_title">
<a class="viewcode-back" href="../../server.html#src.server.stream_title">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_title</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current stream title.&quot;&quot;&quot;</span>
    <span class="n">live</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Stream</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_streams</span><span class="p">(</span><span class="n">user_logins</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">live</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Could not connect to the Twitch API (or stream is offline).&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="stream_uptime">
<a class="viewcode-back" href="../../server.html#src.server.stream_uptime">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;uptime&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_uptime</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the stream uptime.&quot;&quot;&quot;</span>
    <span class="n">live</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Stream</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_streams</span><span class="p">(</span><span class="n">user_logins</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
        <span class="n">td</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
            <span class="n">seconds</span><span class="o">=</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">live</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">started_at</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The stream has been live for </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">td</span><span class="p">)</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Stream is offline (if this is wrong, the Twitch API broke).&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="fetch_run_offset">
<a class="viewcode-back" href="../../server.html#src.server.fetch_run_offset">[docs]</a>
<span class="nd">@add_listener</span><span class="p">(</span><span class="s2">&quot;run_end&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_run_offset</span><span class="p">(</span><span class="n">run</span><span class="p">:</span> <span class="n">RunParser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch and store the run start offset.&quot;&quot;&quot;</span>
    <span class="n">live</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Stream</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_streams</span><span class="p">(</span><span class="n">user_logins</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">live</span><span class="p">:</span> <span class="c1"># just in case</span>
        <span class="n">started</span> <span class="o">=</span> <span class="n">live</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">started_at</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">timestamp</span> <span class="c1"># should be very close to now</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">playtime</span><span class="p">)</span>

        <span class="n">run_start</span> <span class="o">=</span> <span class="n">runtime</span> <span class="o">-</span> <span class="n">duration</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">run_start</span> <span class="o">-</span> <span class="n">started</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;offsets.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">j</span><span class="p">[</span><span class="n">run</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;offsets.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>



<span class="c1"># DO NOT MERGE INTO MAIN UNTIL THE FOLLOWING IS COMPLETELY DONE</span>
<span class="c1"># im merging it and you cant stop me. suck it, past faely!!!</span>
<span class="c1"># TODO:</span>
<span class="c1"># [X] Cover all basic cases (classic, extended, more)</span>
<span class="c1"># [X] When receiving the run file at the end, automatically resolve prediction</span>
<span class="c1"># [ ] (optional) Figure out announcement so the bot can tell chat to vote</span>
<span class="c1"># [ ] Test the heck out of it (does not need to be automated tests)</span>
<span class="c1"># [ ] Implement create, info, resolve, cancel, sync</span>
<span class="c1"># [ ] Add a way to lock in prediction after... something</span>
<span class="c1"># [ ] Have enough text variety that it doesn&#39;t get repetitive</span>
<span class="c1"># [X] Refuse to create a prediction if a Neow bonus was picked</span>
<span class="c1">#</span>
<span class="c1"># More info:</span>
<span class="c1"># - Type &#39;classic&#39; is prediction with only win/lose options</span>
<span class="c1"># - Type &#39;extended&#39; is 5 outcomes (death in each act+win)</span>
<span class="c1"># - Other types do not need to be about a Spire outcome (e.g. FTL)</span>
<span class="c1"># - Character is *optional* and could be used for text</span>
<span class="c1"># - If a savefile exists (but no Neow bonus was picked), use character from that and ignore &#39;char&#39; argument</span>
<span class="c1"># - Duration is is to be coerced to an int but we should accept things like &quot;5m&quot; and be clever about it</span>
<span class="c1"># - If for a Spire run outcome, and a savefile is detected, disallow resolving or cancelling it</span>
<span class="c1"># - TwitchIO&#39;s PartialUser (of which User is a subclass) has method end_prediction</span>

<span class="n">_prediction</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="start_prediction">
<a class="viewcode-back" href="../../server.html#src.server.start_prediction">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_prediction</span><span class="p">(</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">TContext</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">user</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="k">await</span> <span class="n">post_prediction</span><span class="p">(</span><span class="n">TConn</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
    <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="resolve_prediction">
<a class="viewcode-back" href="../../server.html#src.server.resolve_prediction">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">resolve_prediction</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">pred</span><span class="p">:</span> <span class="n">Prediction</span> <span class="o">=</span> <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># todo: there&#39;s some bug here, idk what, but it&#39;s fine. probably. it resolves, anyway</span>
    <span class="k">await</span> <span class="n">pred</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">end_prediction</span><span class="p">(</span>
        <span class="n">TConn</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">prediction_id</span><span class="p">,</span> <span class="s2">&quot;RESOLVED&quot;</span><span class="p">,</span> <span class="n">outcome</span><span class="o">.</span><span class="n">outcome_id</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="auto_resolve_pred">
<a class="viewcode-back" href="../../server.html#src.server.auto_resolve_pred">[docs]</a>
<span class="nd">@add_listener</span><span class="p">(</span><span class="s2">&quot;run_end&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">auto_resolve_pred</span><span class="p">(</span><span class="n">run</span><span class="p">:</span> <span class="n">RunParser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]:</span>
        <span class="k">match</span> <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
            <span class="k">case</span> <span class="s2">&quot;classic&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">resolve_prediction</span><span class="p">(</span><span class="ow">not</span> <span class="n">run</span><span class="o">.</span><span class="n">won</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;extended&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">resolve_prediction</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">acts_beaten</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">a</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported prediction type </span><span class="si">{</span><span class="n">a</span><span class="si">!r}</span><span class="s2"> encountered.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="handle_prediction">
<a class="viewcode-back" href="../../server.html#src.server.handle_prediction">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="n">discord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_prediction</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">TContext</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># TODO: After poll feature is added, if it was to pick a character to play, immediately start a prediction</span>
    <span class="k">match</span> <span class="nb">type</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;start&quot;</span> <span class="o">|</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;A prediction is already running.&quot;</span><span class="p">)</span>

            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;char&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># limited to 15 characters, if any</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;classic&quot;</span><span class="p">,</span>
                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;300&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>  <span class="c1"># just in case</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Needs key-value pair (&#39;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">&#39; is invalid).&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: key </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s2"> is not recognized.&quot;</span><span class="p">)</span>

            <span class="n">save</span> <span class="o">=</span> <span class="n">get_savefile</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">in_game</span> <span class="ow">and</span> <span class="n">save</span><span class="o">.</span><span class="n">neow_bonus</span><span class="o">.</span><span class="n">choice_made</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot start a prediction after a Neow bonus was picked.&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Duration must be an integer if specified.&quot;</span><span class="p">)</span>

            <span class="k">match</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                <span class="k">case</span> <span class="s2">&quot;classic&quot;</span><span class="p">:</span>
                    <span class="n">outcomes</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="s2">&quot;classic&quot;</span><span class="p">][</span><span class="s2">&quot;victory&quot;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">],</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="s2">&quot;classic&quot;</span><span class="p">][</span><span class="s2">&quot;defeat&quot;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">],</span>
                    <span class="p">]</span>

                <span class="k">case</span> <span class="s2">&quot;extended&quot;</span><span class="p">:</span>
                    <span class="n">outcomes</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="s2">&quot;extended&quot;</span><span class="p">][</span><span class="s2">&quot;act1_death&quot;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">],</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="s2">&quot;extended&quot;</span><span class="p">][</span><span class="s2">&quot;act2_death&quot;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">],</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="s2">&quot;extended&quot;</span><span class="p">][</span><span class="s2">&quot;act3_death&quot;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">],</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="s2">&quot;extended&quot;</span><span class="p">][</span><span class="s2">&quot;act4_death&quot;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">],</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="s2">&quot;extended&quot;</span><span class="p">][</span><span class="s2">&quot;victory&quot;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">],</span>
                    <span class="p">]</span>

                <span class="k">case</span> <span class="n">a</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error: prediction type </span><span class="si">{</span><span class="n">a</span><span class="si">!r}</span><span class="s2"> is not recognized.&quot;</span>
                    <span class="p">)</span>

            <span class="n">char</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;char&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">in_game</span><span class="p">:</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">character</span>

            <span class="k">if</span> <span class="n">char</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                        <span class="s2">&quot;Character (&#39;char&#39;) cannot be longer than 15 characters if provided.&quot;</span>
                    <span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="n">_prediction_terms</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]][</span><span class="s2">&quot;char_title&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">char</span><span class="p">)[:</span><span class="mi">45</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_prediction_terms</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]][</span><span class="s2">&quot;title&quot;</span><span class="p">])[:</span><span class="mi">45</span><span class="p">]</span>

            <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="k">await</span> <span class="n">start_prediction</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="s2">&quot;baalorWaffle Predict with your channel points on the outcome of this run! baalorWaffle&quot;</span>
            <span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;info&quot;</span> <span class="o">|</span> <span class="s2">&quot;cancel&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Sadly, that&#39;s not been implemented yet.&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="s2">&quot;resolve&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No prediction is running.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="s2">&quot;Please provide a number to resolve the prediction with.&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="s2">&quot;This should be a number, not... whatever this is.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">_prediction</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">outcomes</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">resolve_prediction</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Results are in! Did you win?&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;And how do you plan to do that?&quot;</span><span class="p">)</span>

        <span class="k">case</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;I don&#39;t know what </span><span class="si">{</span><span class="n">a</span><span class="si">!r}</span><span class="s2"> means.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="now_playing">
<a class="viewcode-back" href="../../server.html#src.server.now_playing">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;playing&quot;</span><span class="p">,</span> <span class="s2">&quot;nowplaying&quot;</span><span class="p">,</span> <span class="s2">&quot;spotify&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">now_playing</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the currently-playing song on Spotify (if any).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">TConn</span><span class="o">.</span><span class="n">live_channels</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">]:</span>
        <span class="c1"># just in case</span>
        <span class="n">TConn</span><span class="o">.</span><span class="n">live_channels</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">live</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">fetch_streams</span><span class="p">(</span><span class="n">user_logins</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">live</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;That&#39;s kinda creepy, not gonna lie...&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="n">j</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">spotify_call</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Could not get token from Spotify API. Retry in a few seconds.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Something went wrong with the Spotify API (</span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;is_playing&quot;</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;We are listening to </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> on the album </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">][</span><span class="s1">&#39;album&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We are not currently listening to anything.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="now_playing_client">
<a class="viewcode-back" href="../../server.html#src.server.now_playing_client">[docs]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/playing&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">now_playing_client</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">get_req_data</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>  <span class="c1"># just checking if key is OK</span>

    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># no Twitch, no Spotify</span>
        <span class="k">raise</span> <span class="n">HTTPServiceUnavailable</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Need Twitch connection for Spotify&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">spotify_call</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">HTTPServiceUnavailable</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Could not connect to the Spotify API&quot;</span><span class="p">)</span></div>



<span class="n">_ongoing_giveaway</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
    <span class="s2">&quot;starter&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="giveaway_handle">
<a class="viewcode-back" href="../../server.html#src.server.giveaway_handle">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;giveaway&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">giveaway_handle</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage a giveaway.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]:</span>
        <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;starter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;A giveaway has started! Type </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">enter to enter!&quot;</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;starter&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Only the person who started the giveaway can resolve it!&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;starter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># just in case</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;uhhh, no one entered??&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TODO: replace with random.sample, maybe?</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]),</span> <span class="n">k</span><span class="o">=</span><span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Congratulations to </span><span class="si">{</span><span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, you have won the giveaway!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Congratulations to the following users for winning the giveaway: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="giveaway_enter">
<a class="viewcode-back" href="../../server.html#src.server.giveaway_enter">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;enter&quot;</span><span class="p">,</span> <span class="n">burst</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">giveaway_enter</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enter into the current giveaway.&quot;&quot;&quot;</span>
    <span class="c1"># it&#39;s a set, dupes won&#39;t do matter. don&#39;t respond to not spam</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No giveaway is happening&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">_ongoing_giveaway</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="card_info">
<a class="viewcode-back" href="../../server.html#src.server.card_info">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;cardinfo&quot;</span><span class="p">,</span> <span class="s2">&quot;relicinfo&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">card_info</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="o">*</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_cache</span><span class="o">=</span><span class="p">{}):</span>
    <span class="c1"># TODO: improve this</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;slaythespire&quot;</span><span class="p">,</span> <span class="s2">&quot;downfall&quot;</span><span class="p">,</span> <span class="s2">&quot;packmaster&quot;</span><span class="p">]</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;session&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cache</span><span class="p">:</span>
            <span class="n">_cache</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>

        <span class="n">session</span><span class="p">:</span> <span class="n">ClientSession</span> <span class="o">=</span> <span class="n">_cache</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">]</span>

        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://slay.ocean.lol/s?</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">%20limit=1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;item&quot;</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">pack</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pack&quot;</span><span class="p">)</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;mod&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pack</span><span class="p">:</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Pack: </span><span class="si">{</span><span class="n">pack</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="s2">&quot;Slay the Spire&quot;</span><span class="p">:</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">mod</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;rarity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;character&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">Base</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find info for </span><span class="si">{</span><span class="n">line</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="p">)</span></div>



<div class="viewcode-block" id="mt_info">
<a class="viewcode-back" href="../../server.html#src.server.mt_info">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;mtinfo&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mt_info</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="o">*</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">mt_query</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find info for </span><span class="si">{</span><span class="n">line</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="p">)</span></div>



<div class="viewcode-block" id="card_with_art">
<a class="viewcode-back" href="../../server.html#src.server.card_with_art">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;card&quot;</span><span class="p">,</span> <span class="s2">&quot;cardart&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">card_with_art</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="o">*</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">Base</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find card </span><span class="si">{</span><span class="n">line</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">cls_name</span> <span class="o">!=</span> <span class="s2">&quot;card&quot;</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Can only find art for cards. Use </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">info instead.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">info</span><span class="p">:</span> <span class="n">Card</span>

    <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/OceanUwU/slaytabase/main/docs/&quot;</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">mod</span> <span class="ow">or</span> <span class="s2">&quot;Slay the Spire&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">format_for_slaytabase</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">internal</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2">/cards/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">.png&quot;</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="save_cache">
<a class="viewcode-back" href="../../server.html#src.server.save_cache">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_cache</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># TODO: &#39;cache reload&#39;, to reload the JSON, but it needs a bunch of state changing</span>
    <span class="c1"># (need to clear all the commands from both bots first)</span>
    <span class="k">match</span> <span class="n">arg</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;clear&quot;</span><span class="p">:</span>
            <span class="n">save</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">save</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Cache cleared.&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="s2">&quot;key&quot;</span> <span class="o">|</span> <span class="s2">&quot;find&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">_cache</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">get_parser</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">_cache</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                        <span class="k">break</span>

            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value in cache: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument </span><span class="si">{</span><span class="n">a</span><span class="si">!r}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="bluekey">
<a class="viewcode-back" href="../../server.html#src.server.bluekey">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;bluekey&quot;</span><span class="p">,</span> <span class="s2">&quot;sapphirekey&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bluekey</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display what was skipped for the Sapphire key.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">save</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sapphire_key_obtained</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We do not have the Sapphire key.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Treasure</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">blue_key</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;We skipped </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">key_relic</span><span class="si">}</span><span class="s2"> on floor </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">floor</span><span class="si">}</span><span class="s2"> for the Sapphire key.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;RunHistoryPlus is not running; cannot get data.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="cards_removed">
<a class="viewcode-back" href="../../server.html#src.server.cards_removed">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;removals&quot;</span><span class="p">,</span> <span class="s2">&quot;removed&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cards_removed</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display which cards were removed.&quot;&quot;&quot;</span>
    <span class="n">removed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">card</span><span class="p">,</span> <span class="n">floor</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">removals</span><span class="p">:</span>
        <span class="n">removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">card</span><span class="si">}</span><span class="s2"> on floor </span><span class="si">{</span><span class="n">floor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">removed</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We did not remove any cards yet.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We removed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="neowbonus">
<a class="viewcode-back" href="../../server.html#src.server.neowbonus">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;neow&quot;</span><span class="p">,</span> <span class="s2">&quot;neowbonus&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">neowbonus</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display what the Neow bonus was.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">save</span><span class="o">.</span><span class="n">neow_bonus</span><span class="o">.</span><span class="n">choice_made</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No Neow bonus taken yet.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Option taken: </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">neow_bonus</span><span class="o">.</span><span class="n">boon_picked</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">neow_bonus</span><span class="o">.</span><span class="n">as_str</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">save</span><span class="o">.</span><span class="n">neow_bonus</span><span class="o">.</span><span class="n">has_info</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="neow_skipped">
<a class="viewcode-back" href="../../server.html#src.server.neow_skipped">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;neowskipped&quot;</span><span class="p">,</span> <span class="s2">&quot;skippedbonus&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">neow_skipped</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">save</span><span class="o">.</span><span class="n">neow_bonus</span><span class="o">.</span><span class="n">choice_made</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;No Neow bonus taken yet.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Options skipped: </span><span class="si">{</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">neow_bonus</span><span class="o">.</span><span class="n">boons_skipped</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="what_if_box">
<a class="viewcode-back" href="../../server.html#src.server.what_if_box">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;pandora&quot;</span><span class="p">,</span> <span class="s2">&quot;pbox&quot;</span><span class="p">,</span> <span class="s2">&quot;pandorasbox&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">what_if_box</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tell us what the Pandora&#39;s Box gave us.&quot;&quot;&quot;</span>
    <span class="n">pbox</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">relics</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Pandora&#39;s Box&quot;</span><span class="p">:</span>
            <span class="n">pbox</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">break</span>

    <span class="c1"># what if n&#39;loth steals our box?</span>
    <span class="k">if</span> <span class="n">pbox</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;Nloth&#39;s Gift&quot;</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;relics&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;metric_event_choices&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">evt</span><span class="p">[</span><span class="s2">&quot;event_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N&#39;loth&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">evt</span><span class="p">[</span><span class="s2">&quot;relics_lost&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Pandora&#39;s Box&quot;</span><span class="p">:</span>
                    <span class="n">pbox</span> <span class="o">=</span> <span class="n">RelicData</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;Pandora&#39;s Box&quot;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">pbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="n">pbox</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pandora&#39;s Box gave us </span><span class="si">{</span><span class="n">formatted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We do not have Pandora&#39;s Box.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="seed_cmd">
<a class="viewcode-back" href="../../server.html#src.server.seed_cmd">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="s2">&quot;currentseed&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">seed_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the run&#39;s current seed.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Current seed: </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">seed</span><span class="si">}{</span><span class="s1">&#39; (set manually)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">save</span><span class="o">.</span><span class="n">is_seeded</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="is_seeded">
<a class="viewcode-back" href="../../server.html#src.server.is_seeded">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;seeded&quot;</span><span class="p">,</span> <span class="s2">&quot;isthisseeded&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">is_seeded</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display whether the current run is seeded.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">is_seeded</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;This run is seeded! See &#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">seed&#39; for the seed.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="s2">&quot;This run is not seeded! Everything you&#39;re seeing is unplanned!&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="run_playtime">
<a class="viewcode-back" href="../../server.html#src.server.run_playtime">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;playtime&quot;</span><span class="p">,</span> <span class="s2">&quot;runtime&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;played&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_playtime</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current playtime for the run.&quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">save</span><span class="o">.</span><span class="n">timedelta</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minutes</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;This run has been going on for </span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">&gt;02</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s2">&gt;02</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="shop_removal_cost">
<a class="viewcode-back" href="../../server.html#src.server.shop_removal_cost">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;shopremoval&quot;</span><span class="p">,</span> <span class="s2">&quot;cardremoval&quot;</span><span class="p">,</span> <span class="s2">&quot;removal&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shop_removal_cost</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current shop removal cost.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Current card removal cost: </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">current_purge</span><span class="si">}</span><span class="s2"> (removed </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">purge_totals</span><span class="si">}</span><span class="s2"> card</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">save</span><span class="o">.</span><span class="n">purge_totals</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="shop_prices">
<a class="viewcode-back" href="../../server.html#src.server.shop_prices">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;shopprices&quot;</span><span class="p">,</span> <span class="s2">&quot;shopranges&quot;</span><span class="p">,</span> <span class="s2">&quot;shoprange&quot;</span><span class="p">,</span> <span class="s2">&quot;ranges&quot;</span><span class="p">,</span> <span class="s2">&quot;shop&quot;</span><span class="p">,</span> <span class="s2">&quot;prices&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shop_prices</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current shop price ranges.&quot;&quot;&quot;</span>
    <span class="n">cards</span><span class="p">,</span> <span class="n">colorless</span><span class="p">,</span> <span class="n">relics</span><span class="p">,</span> <span class="n">potions</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">shop_prices</span>
    <span class="n">cc</span><span class="p">,</span> <span class="n">uc</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">cards</span>
    <span class="n">ul</span><span class="p">,</span> <span class="n">rl</span> <span class="o">=</span> <span class="n">colorless</span>
    <span class="n">cr</span><span class="p">,</span> <span class="n">ur</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="n">relics</span>
    <span class="n">cp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">potions</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Cards: Common </span><span class="si">{</span><span class="n">cc</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">cc</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">, Uncommon </span><span class="si">{</span><span class="n">uc</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">uc</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">, Rare </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2"> | &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Colorless: Uncommon </span><span class="si">{</span><span class="n">ul</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ul</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">, Rare </span><span class="si">{</span><span class="n">rl</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">rl</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2"> | &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Relics: Common/Shop </span><span class="si">{</span><span class="n">cr</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">cr</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">, Uncommon </span><span class="si">{</span><span class="n">ur</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ur</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">, Rare </span><span class="si">{</span><span class="n">rr</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">rr</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2"> | &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Potions: Common </span><span class="si">{</span><span class="n">cp</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">cp</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">, Uncommon </span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">up</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">, Rare </span><span class="si">{</span><span class="n">rp</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">rp</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2"> | &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Card removal: </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">current_purge</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="campfire_heal">
<a class="viewcode-back" href="../../server.html#src.server.campfire_heal">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;heal&quot;</span><span class="p">,</span> <span class="s2">&quot;restheal&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">campfire_heal</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current heal at campfires.&quot;&quot;&quot;</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">max_health</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">relic</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">relics</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">relic</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Regal Pillow&quot;</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="mi">15</span>
            <span class="k">break</span>

    <span class="n">lost</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">save</span><span class="o">.</span><span class="n">current_health</span><span class="p">)</span> <span class="o">-</span> <span class="n">save</span><span class="o">.</span><span class="n">max_health</span><span class="p">)</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lost</span><span class="p">:</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (extra healing lost: </span><span class="si">{</span><span class="n">lost</span><span class="si">}</span><span class="s2"> HP)&quot;</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current campfire heal: </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> HP</span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="nloth_traded">
<a class="viewcode-back" href="../../server.html#src.server.nloth_traded">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;nloth&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">nloth_traded</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display which relic was traded for N&#39;loth&#39;s Gift.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">get</span><span class="p">(</span><span class="s2">&quot;Nloth&#39;s Gift&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">relics_bare</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We do not have N&#39;loth&#39;s Gift.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Event</span><span class="p">):</span> <span class="c1"># this check isn&#39;t strictly needed, but it makes the type checker happy</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;N&#39;loth&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We traded </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">relics_lost</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> for N&#39;loth&#39;s Gift.&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Something went terribly wrong.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="event_likelihood">
<a class="viewcode-back" href="../../server.html#src.server.event_likelihood">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;eventchances&quot;</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">event_likelihood</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display current event chances for the various possibilities in ? rooms.&quot;&quot;&quot;</span>
    <span class="c1"># note: this does not handle pRNG calls like it should - event_seed_count might have something? though only appears to be count of seen ? rooms</span>
    <span class="n">elite</span><span class="p">,</span> <span class="n">hallway</span><span class="p">,</span> <span class="n">shop</span><span class="p">,</span> <span class="n">chest</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">event_chances</span>
    <span class="c1"># elite likelihood is only for the &quot;Deadly Events&quot; custom modifier</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Event type likelihood: &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Normal fight: </span><span class="si">{</span><span class="n">hallway</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> - &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Shop: </span><span class="si">{</span><span class="n">shop</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> - &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Treasure: </span><span class="si">{</span><span class="n">chest</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> - &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Event: </span><span class="si">{</span><span class="mi">1</span><span class="o">-</span><span class="n">hallway</span><span class="o">-</span><span class="n">shop</span><span class="o">-</span><span class="n">chest</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> - &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;See </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">eventrng for more information.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="rare_card_chances">
<a class="viewcode-back" href="../../server.html#src.server.rare_card_chances">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;rare&quot;</span><span class="p">,</span> <span class="s2">&quot;rarecard&quot;</span><span class="p">,</span> <span class="s2">&quot;rarechance&quot;</span><span class="p">)</span>  <span class="c1"># see comment in save.py -- this is not entirely accurate</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rare_card_chances</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current chance to see rare cards in rewards and shops.&quot;&quot;&quot;</span>
    <span class="n">regular</span><span class="p">,</span> <span class="n">elites</span><span class="p">,</span> <span class="n">shops</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">rare_chance</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The current chance of seeing a rare card is </span><span class="si">{</span><span class="n">regular</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;in normal fight card rewards, </span><span class="si">{</span><span class="n">elites</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> in elite fight &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;card rewards, and </span><span class="si">{</span><span class="n">shops</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> in shops.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="relic_info">
<a class="viewcode-back" href="../../server.html#src.server.relic_info">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;relic&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">relic_info</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display information about the current relics.&quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">relics</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="si">}</span><span class="s2"> relics.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We only have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="si">}</span><span class="s2"> relics!&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">relicData</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">:=</span> <span class="n">relicData</span><span class="o">.</span><span class="n">get_details</span><span class="p">()):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The relic at position </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">relicData</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">relicData</span><span class="o">.</span><span class="n">relic</span><span class="o">.</span><span class="n">description</span><span class="si">}{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="relics_page2">
<a class="viewcode-back" href="../../server.html#src.server.relics_page2">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;allrelics&quot;</span><span class="p">,</span> <span class="s2">&quot;offscreen&quot;</span><span class="p">,</span> <span class="s2">&quot;page2&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">relics_page2</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the relics on page 2.&quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">relics</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We only have one page of relics!&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">relics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">relic</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">25</span><span class="p">:]:</span>
        <span class="n">relics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relic</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The relics past page 1 are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="seen_relic">
<a class="viewcode-back" href="../../server.html#src.server.seen_relic">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;seen&quot;</span><span class="p">,</span> <span class="s2">&quot;seenrelic&quot;</span><span class="p">,</span> <span class="s2">&quot;available&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">seen_relic</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">,</span> <span class="o">*</span><span class="n">relic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Output whether a given relic has been seen.&quot;&quot;&quot;</span>
    <span class="n">relic</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relic</span><span class="p">)</span>
    <span class="n">relics</span> <span class="o">=</span> <span class="p">[</span><span class="n">relic</span><span class="p">]</span>

    <span class="c1"># Check if the relic is referencing a relic set:</span>
    <span class="n">relic_set</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">relic</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relic_set</span><span class="p">,</span> <span class="n">RelicSet</span><span class="p">):</span>
        <span class="n">relics</span> <span class="o">=</span> <span class="n">relic_set</span><span class="o">.</span><span class="n">relic_list</span>

    <span class="n">replies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">relic</span> <span class="ow">in</span> <span class="n">relics</span><span class="p">:</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Relic</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">relic</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find relic </span><span class="si">{</span><span class="n">relic</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">cls_name</span> <span class="o">!=</span> <span class="s2">&quot;relic&quot;</span><span class="p">:</span>
            <span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Can only look for relics seen.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">relics_bare</span><span class="p">:</span>
            <span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;We already have </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">! It&#39;s at position </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">relics_bare</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">tier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Common&quot;</span><span class="p">,</span> <span class="s2">&quot;Uncommon&quot;</span><span class="p">,</span> <span class="s2">&quot;Rare&quot;</span><span class="p">,</span> <span class="s2">&quot;Shop&quot;</span><span class="p">):</span>
            <span class="k">match</span> <span class="n">data</span><span class="o">.</span><span class="n">tier</span><span class="p">:</span>
                <span class="k">case</span> <span class="s2">&quot;Boss&quot;</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For boss relics, see </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">picked instead.&quot;</span>
                <span class="k">case</span> <span class="s2">&quot;Starter&quot;</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Starter relics can&#39;t exactly be seen during a run. What?&quot;</span>
                <span class="k">case</span> <span class="s2">&quot;Special&quot;</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;We can only see Special relics from events.&quot;</span>
                <span class="k">case</span> <span class="n">a</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;This relic is tagged as rarity </span><span class="si">{</span><span class="n">a</span><span class="si">!r}</span><span class="s2">, and I don&#39;t know what that means.&quot;</span>
            <span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;We can only check for Common, Uncommon, Rare, or Shop relics. </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">save</span><span class="o">.</span><span class="n">available_relic</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;We have not seen </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> yet! There&#39;s a chance we&#39;ll see it!&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; (or maybe it doesn&#39;t belong to this character)&quot;</span>
            <span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;We have already seen </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> this run</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">, and cannot get it again baalorHubris&quot;</span>
            <span class="p">)</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">replies</span><span class="p">))</span></div>



<div class="viewcode-block" id="skipped_boss_relics">
<a class="viewcode-back" href="../../server.html#src.server.skipped_boss_relics">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="s2">&quot;picked&quot;</span><span class="p">,</span> <span class="s2">&quot;skippedboss&quot;</span><span class="p">,</span> <span class="s2">&quot;bossrelic&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">skipped_boss_relics</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the boss relics that were taken and skipped.&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">boss_relics</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">choices</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We have not picked any boss relics yet.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">skip_template</span> <span class="o">=</span> <span class="s2">&quot;We saw </span><span class="si">{1[0]}</span><span class="s2">, </span><span class="si">{1[1]}</span><span class="s2"> and </span><span class="si">{1[2]}</span><span class="s2"> at the end of Act </span><span class="si">{0}</span><span class="s2"> and skipped all that junk! baalorBoot&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;We picked </span><span class="si">{1[0]}</span><span class="s2"> at the end of Act </span><span class="si">{0}</span><span class="s2">, and skipped </span><span class="si">{1[1]}</span><span class="s2"> and </span><span class="si">{1[2]}</span><span class="s2">.&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">picked</span><span class="p">,</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
        <span class="n">use</span> <span class="o">=</span> <span class="n">skip_template</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">picked</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use</span> <span class="o">=</span> <span class="n">template</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">picked</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">skipped</span><span class="p">)</span>

        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span></div>



<div class="viewcode-block" id="bottled_cards">
<a class="viewcode-back" href="../../server.html#src.server.bottled_cards">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;bottled&quot;</span><span class="p">,</span> <span class="s2">&quot;bottledcards&quot;</span><span class="p">,</span> <span class="s2">&quot;bottledcard&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bottled_cards</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all bottled cards.&quot;&quot;&quot;</span>
    <span class="n">emoji_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Bottled Flame&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\N{FIRE}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Bottled Lightning&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\N{HIGH VOLTAGE SIGN}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Bottled Tornado&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\N{CLOUD WITH TORNADO}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">bottle_strings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bottle</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">bottles</span><span class="p">:</span>
        <span class="n">bottle_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji_dict</span><span class="p">[</span><span class="n">bottle</span><span class="o">.</span><span class="n">bottle_id</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bottle</span><span class="o">.</span><span class="n">card</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bottle_strings</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bottle_strings</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We do not have any bottled cards.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="dagger_scaling">
<a class="viewcode-back" href="../../server.html#src.server.dagger_scaling">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;dagger&quot;</span><span class="p">,</span> <span class="s2">&quot;ritualdagger&quot;</span><span class="p">)</span> <span class="c1"># TODO: add tests for these</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dagger_scaling</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the damage value of Ritual Dagger.&quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">get_meta_scaling_cards</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">card</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">scaling</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Ritual Dagger&quot;</span> <span class="ow">in</span> <span class="n">card</span><span class="p">:</span> <span class="c1"># account for upgrade</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">card</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>

    <span class="k">match</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We do not have a Ritual Dagger.&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">card</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">card</span><span class="si">}</span><span class="s2"> is currently at </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> damage.&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Our Ritual Daggers are at </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">last</span><span class="si">}</span><span class="s2"> damage.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="algo_scaling">
<a class="viewcode-back" href="../../server.html#src.server.algo_scaling">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;algo&quot;</span><span class="p">,</span> <span class="s2">&quot;genetic&quot;</span><span class="p">,</span> <span class="s2">&quot;algorithm&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">algo_scaling</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the block value of Genetic Algorithm.&quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">get_meta_scaling_cards</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">card</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">scaling</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Genetic Algorithm&quot;</span> <span class="ow">in</span> <span class="n">card</span><span class="p">:</span> <span class="c1"># account for upgrade</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">card</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>

    <span class="k">match</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We do not have a Genetic Algorithm.&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">card</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">card</span><span class="si">}</span><span class="s2"> is currently at </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> block.&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Our Genetic Algorithms are at </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">last</span><span class="si">}</span><span class="s2"> block.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="modifiers">
<a class="viewcode-back" href="../../server.html#src.server.modifiers">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="s2">&quot;modifiers&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">modifiers</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all custom modifiers for the run.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">modifiers</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;This is a standard run.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="score">
<a class="viewcode-back" href="../../server.html#src.server.score">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current score of the run&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">modded</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Score: ~</span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Score: </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="mt_clans">
<a class="viewcode-back" href="../../server.html#src.server.mt_clans">[docs]</a>
<span class="nd">@mt_command</span><span class="p">(</span><span class="s2">&quot;clans&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mt_clans</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">MonsterSave</span><span class="p">):</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">main_class</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">main_exiled</span><span class="p">:</span>
        <span class="n">main</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main</span><span class="si">}</span><span class="s2"> (Exiled)&quot;</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">sub_class</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">sub_exiled</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s2"> (Exiled)&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The clans are </span><span class="si">{</span><span class="n">main</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="mt_mutators">
<a class="viewcode-back" href="../../server.html#src.server.mt_mutators">[docs]</a>
<span class="nd">@mt_command</span><span class="p">(</span><span class="s2">&quot;mutators&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mt_mutators</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">MonsterSave</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">:=</span> <span class="n">save</span><span class="o">.</span><span class="n">mutators</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The mutators are: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># @mt_command(&quot;challenge&quot;)</span>
<div class="viewcode-block" id="mt_challenge">
<a class="viewcode-back" href="../../server.html#src.server.mt_challenge">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mt_challenge</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">MonsterSave</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">save</span><span class="o">.</span><span class="n">challenge</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We are not currently playing an Expert Challenge.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;We are currently playing the Expert Challenge </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">info</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="mt_artifact">
<a class="viewcode-back" href="../../server.html#src.server.mt_artifact">[docs]</a>
<span class="nd">@mt_command</span><span class="p">(</span><span class="s2">&quot;artifact&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mt_artifact</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">MonsterSave</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">artifacts</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="si">}</span><span class="s2"> artifacts.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We only have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="si">}</span><span class="s2"> artifacts!&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">relicData</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The artifact at position </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">relicData</span><span class="o">.</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="mt_pyre">
<a class="viewcode-back" href="../../server.html#src.server.mt_pyre">[docs]</a>
<span class="nd">@mt_command</span><span class="p">(</span><span class="s2">&quot;pyre&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mt_pyre</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">MonsterSave</span><span class="p">):</span>
    <span class="n">ability</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">pyre</span><span class="o">.</span><span class="n">ability</span><span class="p">:</span>
        <span class="n">ability</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (Ability: </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">pyre</span><span class="o">.</span><span class="n">ability</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We are using </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">pyre</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">pyre</span><span class="o">.</span><span class="n">description</span><span class="si">}{</span><span class="n">ability</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="curses">
<a class="viewcode-back" href="../../server.html#src.server.curses">[docs]</a>
<span class="nd">@slice_command</span><span class="p">(</span><span class="s2">&quot;curses&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">curses</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">CurrentRun</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current run&#39;s curses.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;We are running Classic on </span><span class="si">{</span><span class="n">save</span><span class="o">.</span><span class="n">difficulty</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">modifiers</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="items">
<a class="viewcode-back" href="../../server.html#src.server.items">[docs]</a>
<span class="nd">@slice_command</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">CurrentRun</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the current run&#39;s unequipped items.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The unequipped items are </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We have no unequipped items.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="fairy_released">
<a class="viewcode-back" href="../../server.html#src.server.fairy_released">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;fairyreleased&quot;</span><span class="p">,</span> <span class="s2">&quot;released&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fairy_released</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the count of fairy that have been released after the Heart.&quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">_runs_cache</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">won</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pot</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">discarded_potions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">internal</span> <span class="o">==</span> <span class="s2">&quot;FairyPotion&quot;</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We have freed </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> fairies at the top of the Spire!&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_last">
<a class="viewcode-back" href="../../server.html#src.server.get_last">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;last&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_last</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">arg1</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">arg2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the last run/win/loss.&quot;&quot;&quot;</span>
    <span class="n">char</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">won</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">arg2</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg1</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">arg2</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">elif</span> <span class="n">arg1</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg1</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">match</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">case</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># nothing to worry about</span>
        <span class="k">case</span> <span class="p">[</span><span class="s2">&quot;win&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="p">[</span><span class="s2">&quot;victory&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]:</span>
            <span class="n">won</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">case</span> <span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="p">[</span><span class="s2">&quot;death&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="p">[</span><span class="s2">&quot;l&quot;</span><span class="p">]:</span>
            <span class="n">won</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">case</span> <span class="p">[</span><span class="n">a</span><span class="p">]:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">case</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]:</span>
            <span class="k">match</span> <span class="n">a</span><span class="p">:</span>
                <span class="k">case</span> <span class="s2">&quot;win&quot;</span> <span class="o">|</span> <span class="s2">&quot;victory&quot;</span> <span class="o">|</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
                    <span class="n">won</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">case</span> <span class="s2">&quot;loss&quot;</span> <span class="o">|</span> <span class="s2">&quot;death&quot;</span> <span class="o">|</span> <span class="s2">&quot;l&quot;</span><span class="p">:</span>
                    <span class="n">won</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">a</span>
                    <span class="k">match</span> <span class="n">b</span><span class="p">:</span>
                        <span class="k">case</span> <span class="s2">&quot;win&quot;</span> <span class="o">|</span> <span class="s2">&quot;victory&quot;</span> <span class="o">|</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
                            <span class="n">won</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">case</span> <span class="s2">&quot;loss&quot;</span> <span class="o">|</span> <span class="s2">&quot;death&quot;</span> <span class="o">|</span> <span class="s2">&quot;l&quot;</span><span class="p">:</span>
                            <span class="n">won</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">match</span> <span class="n">char</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;ironclad&quot;</span> <span class="o">|</span> <span class="s2">&quot;ic&quot;</span> <span class="o">|</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="s2">&quot;Ironclad&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;silent&quot;</span> <span class="o">|</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="s2">&quot;Silent&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;defect&quot;</span> <span class="o">|</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="s2">&quot;Defect&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;watcher&quot;</span> <span class="o">|</span> <span class="s2">&quot;wa&quot;</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="s2">&quot;Watcher&quot;</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>  <span class="c1"># might be a mod character</span>

    <span class="k">await</span> <span class="n">_last_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">won</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_last_run">
<a class="viewcode-back" href="../../server.html#src.server.get_last_run">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;lastrun&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_last_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the last run.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">_last_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_last_win">
<a class="viewcode-back" href="../../server.html#src.server.get_last_win">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;lastwin&quot;</span><span class="p">,</span> <span class="s2">&quot;lastvictory&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_last_win</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the last win.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">_last_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_last_loss">
<a class="viewcode-back" href="../../server.html#src.server.get_last_loss">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;lastloss&quot;</span><span class="p">,</span> <span class="s2">&quot;lastdeath&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_last_loss</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the last loss.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">_last_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>



<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_last_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">get_latest_run</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">latest</span><span class="o">.</span><span class="n">won</span>  <span class="c1"># making sure it&#39;s not None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not understand character </span><span class="si">{</span><span class="n">character</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;run&quot;</span>
    <span class="k">if</span> <span class="n">character</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">character</span><span class="si">}</span><span class="s2"> run&quot;</span>
    <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;winning </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;lost </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The last </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;s history can be viewed at </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/runs/</span><span class="si">{</span><span class="n">latest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<div class="viewcode-block" id="next_run">
<a class="viewcode-back" href="../../server.html#src.server.next_run">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">next_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return which character is next in the rotation.&quot;&quot;&quot;</span>
    <span class="n">save</span> <span class="o">=</span> <span class="n">get_savefile</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">character</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">save</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;You&#39;re watching it right now!&quot;</span><span class="p">)</span>

    <span class="n">latest</span> <span class="o">=</span> <span class="n">get_latest_run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">latest</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">matched</span><span class="o">.</span><span class="n">prev</span>

    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Ironclad&quot;</span><span class="p">,</span> <span class="s2">&quot;Silent&quot;</span><span class="p">,</span> <span class="s2">&quot;Defect&quot;</span><span class="p">,</span> <span class="s2">&quot;Watcher&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">latest</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Something went wrong.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The next run will be with </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="wall_card">
<a class="viewcode-back" href="../../server.html#src.server.wall_card">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;wall&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wall_card</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch the card in the wall for the ladder savefile.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;ladder&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Error: could not find Ladder savefile.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Current card in the </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">hole in the wall for the ladder savefile: </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">hole_card</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="set_run_stats_by_date">
<a class="viewcode-back" href="../../server.html#src.server.set_run_stats_by_date">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;me&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set_run_stats_by_date</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">date_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the default range for the run stats by date, this is separate from the all-time stats run cache.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">date_string</span> <span class="o">==</span> <span class="s2">&quot;reset&quot;</span><span class="p">:</span>
        <span class="n">update_range</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Range has been reset for all-time stats&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">date_tuple</span> <span class="o">=</span> <span class="n">parse_date_range</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="s2">&quot;Invalid date string. Use YYYY/MM/DD-YYYY/MM/DD (MM and DD optional), YYYY/MM/DD+ (no end date), YYYY/MM/DD- (no start date)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="n">update_range</span><span class="p">(</span><span class="n">date_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Run stats have been updated for the given range&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_wins_cmd">
<a class="viewcode-back" href="../../server.html#src.server.calculate_wins_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;kills&quot;</span><span class="p">,</span> <span class="s2">&quot;wins&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">calculate_wins_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">date_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the cumulative number of wins for an optional date range.&quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A20 Heart kills (</span><span class="si">{0.date_range_string}</span><span class="s2">): Total: </span><span class="si">{1.all_character_count}</span><span class="s2"> - Ironclad: </span><span class="si">{1.ironclad_count}</span><span class="s2"> - Silent: </span><span class="si">{1.silent_count}</span><span class="s2"> - Defect: </span><span class="si">{1.defect_count}</span><span class="s2"> - Watcher: </span><span class="si">{1.watcher_count}</span><span class="s2">&quot;</span>
    <span class="k">await</span> <span class="n">_send_standard_run_stats_message</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;all_wins&quot;</span><span class="p">,</span> <span class="n">date_string</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_losses_cmd">
<a class="viewcode-back" href="../../server.html#src.server.calculate_losses_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;losses&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">calculate_losses_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">date_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the cumulative number of losses for an optional date range.&quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A20 Heart losses (</span><span class="si">{0.date_range_string}</span><span class="s2">): Total: </span><span class="si">{1.all_character_count}</span><span class="s2"> - Ironclad: </span><span class="si">{1.ironclad_count}</span><span class="s2"> - Silent: </span><span class="si">{1.silent_count}</span><span class="s2"> - Defect: </span><span class="si">{1.defect_count}</span><span class="s2"> - Watcher: </span><span class="si">{1.watcher_count}</span><span class="s2">&quot;</span>
    <span class="k">await</span> <span class="n">_send_standard_run_stats_message</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;all_losses&quot;</span><span class="p">,</span> <span class="n">date_string</span><span class="p">)</span></div>



<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_standard_run_stats_message</span><span class="p">(</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
    <span class="n">run_stats</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">date_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_stats</span> <span class="o">=</span> <span class="n">get_run_stats_by_date</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_stats</span> <span class="o">=</span> <span class="n">get_run_stats_by_date_string</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="s2">&quot;Invalid date string or start date was after end date. Use YYYY/MM/DD-YYYY/MM/DD (MM and DD optional), YYYY/MM/DD+ (no end date), YYYY/MM/DD- (no start date)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Start date is after end date&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_stats</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">run_stats</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)))</span>


<span class="n">_display</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">_words</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Rotating&quot;</span><span class="p">,</span> <span class="s2">&quot;Ironclad&quot;</span><span class="p">,</span> <span class="s2">&quot;Silent&quot;</span><span class="p">,</span> <span class="s2">&quot;Defect&quot;</span><span class="p">,</span> <span class="s2">&quot;Watcher&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_set_display</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_display</span><span class="p">:</span>  <span class="c1"># we get</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;streak&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">toggles</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">toggles</span><span class="p">:</span>
            <span class="n">_display</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">_display</span><span class="p">:</span>  <span class="c1"># we set</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;streak&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_display</span><span class="p">))</span>


<div class="viewcode-block" id="streak_display">
<a class="viewcode-back" href="../../server.html#src.server.streak_display">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;rotation&quot;</span><span class="p">,</span> <span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">streak_display</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change the !streak command display.&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;risdw&quot;</span>
    <span class="n">word</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_display</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">_display</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">word</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_words</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_display</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">_get_set_display</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Streak display changed to </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_streak_cmd">
<a class="viewcode-back" href="../../server.html#src.server.calculate_streak_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;streak&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">calculate_streak_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display Baalor&#39;s current streak for Ascension 20 Heart kills.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_display</span><span class="p">:</span>
        <span class="n">_get_set_display</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_display</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">_words</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_count&quot;</span> <span class="k">if</span> <span class="n">word</span> <span class="o">!=</span> <span class="s2">&quot;Rotating&quot;</span> <span class="k">else</span> <span class="s2">&quot;all_character_count&quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">: </span><span class="se">{{</span><span class="s2">0.</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">final</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Current streak: </span><span class="si">{</span><span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">run_stats</span> <span class="o">=</span> <span class="n">get_all_run_stats</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_stats</span><span class="o">.</span><span class="n">streaks</span><span class="p">))</span></div>



<div class="viewcode-block" id="calculate_pb_cmd">
<a class="viewcode-back" href="../../server.html#src.server.calculate_pb_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;pb&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">calculate_pb_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">date_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display Baalor&#39;s Personal Best streaks for Ascension 20 Heart kills for an optional date range.&quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Baalor&#39;s PB A20H Streaks (</span><span class="si">{0.date_range_string}</span><span class="s2">) | Rotating: </span><span class="si">{1.all_character_count}</span><span class="s2"> - Ironclad: </span><span class="si">{1.ironclad_count}</span><span class="s2"> - Silent: </span><span class="si">{1.silent_count}</span><span class="s2"> - Defect: </span><span class="si">{1.defect_count}</span><span class="s2"> - Watcher: </span><span class="si">{1.watcher_count}</span><span class="s2">&quot;</span>
    <span class="n">run_stats</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">date_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_stats</span> <span class="o">=</span> <span class="n">get_all_run_stats</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_stats</span> <span class="o">=</span> <span class="n">get_run_stats_by_date_string</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="s2">&quot;Invalid date string or start date was after end date. Use YYYY/MM/DD-YYYY/MM/DD (MM and DD optional), YYYY/MM/DD+ (no end date), YYYY/MM/DD- (no start date)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Start date is after end date&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_stats</span><span class="p">,</span> <span class="n">run_stats</span><span class="o">.</span><span class="n">pb</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_wrs">
<a class="viewcode-back" href="../../server.html#src.server.get_wrs">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;wr&quot;</span><span class="p">,</span> <span class="s2">&quot;worldrecords&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_wrs</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://script.google.com/macros/s/AKfycbwwVnFP2FhAuTi1a4xh67uv_GYI63ggnX7e6wezlQmWlpr8z4B0IXVKuT_ta-seYnrt/exec?format=json&quot;</span>
    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Sorry, couldn&#39;t access the data. Try again later.&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">_words</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">char</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;streak&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;ongoing&#39;</span><span class="p">]:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; (ongoing)&quot;</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;As far as we know, these are the current A20H world records: </span><span class="si">{</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2"> -- For Baalor&#39;s own records, see </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">pb&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_winrate_cmd">
<a class="viewcode-back" href="../../server.html#src.server.calculate_winrate_cmd">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;winrate&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">calculate_winrate_cmd</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">date_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the winrate for Baalor&#39;s A20 Heart kills for an optional date range.&quot;&quot;&quot;</span>
    <span class="n">run_stats</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">date_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_stats</span> <span class="o">=</span> <span class="n">get_run_stats_by_date</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_stats</span> <span class="o">=</span> <span class="n">get_run_stats_by_date_string</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="s2">&quot;Invalid date string or start date was after end date. Use YYYY/MM/DD-YYYY/MM/DD (MM and DD optional), YYYY/MM/DD+ (no end date), YYYY/MM/DD- (no start date)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Start date is after end date&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="n">wins</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_wins</span><span class="o">.</span><span class="n">all_character_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_wins</span><span class="o">.</span><span class="n">ironclad_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_wins</span><span class="o">.</span><span class="n">silent_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_wins</span><span class="o">.</span><span class="n">defect_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_wins</span><span class="o">.</span><span class="n">watcher_count</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_losses</span><span class="o">.</span><span class="n">all_character_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_losses</span><span class="o">.</span><span class="n">ironclad_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_losses</span><span class="o">.</span><span class="n">silent_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_losses</span><span class="o">.</span><span class="n">defect_count</span><span class="p">,</span>
        <span class="n">run_stats</span><span class="o">.</span><span class="n">all_losses</span><span class="o">.</span><span class="n">watcher_count</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wins</span><span class="p">,</span> <span class="n">losses</span><span class="p">)]</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Baalor&#39;s winrate (</span><span class="si">{</span><span class="n">run_stats</span><span class="o">.</span><span class="n">date_range_string</span><span class="si">}</span><span class="s2">): Overall: </span><span class="si">{</span><span class="n">rate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> - Ironclad: </span><span class="si">{</span><span class="n">rate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> - Silent: </span><span class="si">{</span><span class="n">rate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> - Defect: </span><span class="si">{</span><span class="n">rate</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> - Watcher: </span><span class="si">{</span><span class="n">rate</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="unmastered">
<a class="viewcode-back" href="../../server.html#src.server.unmastered">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;unmastered&quot;</span><span class="p">,</span> <span class="n">optional_save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">unmastered</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;unmastered&quot;</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s2">&quot;unmastered&quot;</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="n">cards</span> <span class="o">=</span> <span class="n">get_mastered</span><span class="p">()</span><span class="o">.</span><span class="n">mastered_cards</span>

    <span class="n">final</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_internal_cache</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">cls_name</span> <span class="o">!=</span> <span class="s2">&quot;card&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Card</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">value</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Status&quot;</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">rarity</span> <span class="o">==</span> <span class="s2">&quot;Special&quot;</span>
        <span class="p">):</span>  <span class="c1"># all &quot;special&quot; ones are already mastered</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">:</span>
            <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The cards left to master are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">final</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">final</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The final card left to master is </span><span class="si">{</span><span class="n">final</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Mastery Challenge Complete! Nothing left to master! baalorEZ baalorX2&quot;</span>

    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s2">&quot;unmastered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="mastered_stuff">
<a class="viewcode-back" href="../../server.html#src.server.mastered_stuff">[docs]</a>
<span class="nd">@command</span><span class="p">(</span><span class="s2">&quot;mastered&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mastered_stuff</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="o">*</span><span class="n">card</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tell us whether a certain card or relic is mastered.&quot;&quot;&quot;</span>
    <span class="n">mastery_stats</span> <span class="o">=</span> <span class="n">get_mastered</span><span class="p">()</span>
    <span class="c1"># total = (75 * 4) + 39 + 13 # 178 relics</span>
    <span class="c1"># chars = {&quot;Red&quot;: &quot;Ironclad&quot;, &quot;Green&quot;: &quot;Silent&quot;, &quot;Blue&quot;: &quot;Defect&quot;, &quot;Purple&quot;: &quot;Watcher&quot;}</span>
    <span class="c1"># d = defaultdict(dict)</span>

    <span class="c1"># for card, (color, char, ts) in cards.items():</span>
    <span class="c1">#    d[color][card] = (char, ts)</span>

    <span class="c1"># msg = [&quot;Current mastery progression:&quot;]</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find card or relic </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">mod</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;We do not attempt to master modded content.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">match</span> <span class="n">info</span><span class="o">.</span><span class="n">cls_name</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;card&quot;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">mastery_stats</span><span class="o">.</span><span class="n">mastered_cards</span>
        <span class="k">case</span> <span class="s2">&quot;relic&quot;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">mastery_stats</span><span class="o">.</span><span class="n">mastered_relics</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Only cards or relics may be mastered.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">cls_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> IS mastered! Run: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/runs/</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">cls_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is NOT mastered.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="current_mastery_check">
<a class="viewcode-back" href="../../server.html#src.server.current_mastery_check">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;candidates&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">current_mastery_check</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Output what cards in the current run can be mastered if won.&quot;&quot;&quot;</span>
    <span class="n">one_ofs</span><span class="p">,</span> <span class="n">cards_can_master</span><span class="p">,</span> <span class="n">relics_can_master</span> <span class="o">=</span> <span class="n">get_current_masteries</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cards_can_master</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The cards that can be mastered this run are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cards_can_master</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are no new cards in this run that can be mastered.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="calipers">
<a class="viewcode-back" href="../../server.html#src.server.calipers">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;cwbgh&quot;</span><span class="p">,</span> <span class="s2">&quot;cwbg&quot;</span><span class="p">,</span> <span class="n">optional_save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">calipers</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Savefile</span><span class="p">]):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Calipers would be good here baalorCalipers baalorSmug&quot;</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Barricade&#39;</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">deck_card_ids</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Who needs calipers when we have Barricade!? baalorStare&quot;</span>
        <span class="k">elif</span> <span class="n">query</span><span class="p">(</span><span class="s2">&quot;calipers&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">relics_bare</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Calipers ARE good here! baalorCalipers baalorSmug&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;Blur&#39;</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">deck_card_ids</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;We have Calipers at home! baalorSmug</span><span class="se">\n</span><span class="s2">At home: Blur&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">save</span><span class="o">.</span><span class="n">available_relic</span><span class="p">(</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;calipers&quot;</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Calipers would have been good here... baalorHubris&quot;</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="active_mods">
<a class="viewcode-back" href="../../server.html#src.server.active_mods">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;mods&quot;</span><span class="p">,</span> <span class="n">optional_save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">active_mods</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">):</span>
    <span class="c1"># use the old message if we don&#39;t have info from activemods</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Baalor uses a variety of mods for the stream. You can see a list of all mods here: https://baalorlord.tv/mods&quot;</span>
    <span class="k">if</span> <span class="n">save</span> <span class="ow">and</span> <span class="n">save</span><span class="o">.</span><span class="n">has_activemods</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">mods</span><span class="p">]</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mods</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, and </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For this run, we&#39;re using the mods </span><span class="si">{</span><span class="n">mods</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">For more info, try !mod [mod name]&quot;</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="active_mod_info">
<a class="viewcode-back" href="../../server.html#src.server.active_mod_info">[docs]</a>
<span class="nd">@with_savefile</span><span class="p">(</span><span class="s2">&quot;mod&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">active_mod_info</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="n">Savefile</span><span class="p">,</span> <span class="o">*</span><span class="n">modname</span><span class="p">):</span>
    <span class="c1"># don&#39;t do anything if we don&#39;t have info from activemods</span>
    <span class="k">if</span> <span class="n">save</span><span class="o">.</span><span class="n">has_activemods</span><span class="p">:</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">save</span><span class="o">.</span><span class="n">mods</span><span class="p">])</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;This can tell you information about a specific mod.  Use it like this: !mod </span><span class="si">{</span><span class="n">choice</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="n">find_mod</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find any mod called </span><span class="si">{</span><span class="n">modname</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>                                
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mod</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> was created by </span><span class="si">{</span><span class="n">mod</span><span class="o">.</span><span class="n">authors_formatted</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Description: </span><span class="si">{</span><span class="n">mod</span><span class="o">.</span><span class="n">description_formatted</span><span class="si">}</span><span class="se">\n</span><span class="s2">Try it out here: </span><span class="si">{</span><span class="n">mod</span><span class="o">.</span><span class="n">mod_url</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="commands_page">
<a class="viewcode-back" href="../../server.html#src.server.commands_page">[docs]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/commands&quot;</span><span class="p">)</span>
<span class="nd">@template</span><span class="p">(</span><span class="s2">&quot;commands.jinja2&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">commands_page</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;botname&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TConn</span><span class="o">.</span><span class="n">commands</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">DConn</span><span class="o">.</span><span class="n">all_commands</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">d</span></div>



<div class="viewcode-block" id="individual_cmd">
<a class="viewcode-back" href="../../server.html#src.server.individual_cmd">[docs]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/commands/</span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nd">@template</span><span class="p">(</span><span class="s2">&quot;command_single.jinja2&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">individual_cmd</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">match_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
    <span class="n">tcmd</span> <span class="o">=</span> <span class="n">dcmd</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tcmd</span><span class="p">:</span> <span class="n">TwitchCommand</span> <span class="o">=</span> <span class="n">TConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dcmd</span><span class="p">:</span> <span class="n">DiscordCommand</span> <span class="o">=</span> <span class="n">DConn</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">tcmd</span> <span class="ow">or</span> <span class="n">dcmd</span>
    <span class="k">if</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_cmds</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;builtin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="s2">&quot;&lt;username&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">,</span> <span class="n">words</span><span class="o">=</span><span class="s2">&quot;&lt;words&gt;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_consts</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;lt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">word</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_cmds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Just in case it&#39;s not a list...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;builtin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fndoc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">enabled</span>

    <span class="c1"># d[&quot;twitch&quot;] = (&quot;No&quot; if tcmd is None else &quot;Yes&quot;)</span>
    <span class="c1"># d[&quot;discord&quot;] = (&quot;No&quot; if dcmd is None else &quot;Yes&quot;)</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;twitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcmd</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;discord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcmd</span>

    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;permissions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_perms</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cmd</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_perms</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span>

    <span class="k">return</span> <span class="n">d</span></div>



<div class="viewcode-block" id="automatic_client_report">
<a class="viewcode-back" href="../../server.html#src.server.automatic_client_report">[docs]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/report&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">automatic_client_report</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">get_req_data</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;traceback&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">discord</span><span class="o">.</span><span class="n">auto_report</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ar</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ar</span><span class="o">.</span><span class="n">server</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ar</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPServiceUnavailable</span>

    <span class="n">guild</span> <span class="o">=</span> <span class="n">DConn</span><span class="o">.</span><span class="n">get_guild</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">guild</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPServiceUnavailable</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">guild</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPServiceUnavailable</span>

    <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;[Automatic Client Reporting]</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">()</span></div>



<span class="n">_oauth_state</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="check_token_validity">
<a class="viewcode-back" href="../../server.html#src.server.check_token_validity">[docs]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/twitch/check-token&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_token_validity</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">get_req_data</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>  <span class="c1"># check if the key is OK</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;DISABLED&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;NOT_EXTENDED&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_id</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_secret</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;NO_CREDENTIALS&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">TConn</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;WORKING&quot;</span><span class="p">)</span>

    <span class="c1"># Need to authenticate for the first time (presumably)</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span><span class="o">,</span><span class="w"> </span><span class="nn">urllib.parse</span>

    <span class="k">global</span> <span class="n">_oauth_state</span>
    <span class="n">_oauth_state</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/twitch/receive-token&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">scopes</span><span class="p">),</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">_oauth_state</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://id.twitch.tv/oauth2/authorize?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;NEEDS_CONNECTION:</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_new_token">
<a class="viewcode-back" href="../../server.html#src.server.get_new_token">[docs]</a>
<span class="nd">@router</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s2">&quot;/twitch/receive-token&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_new_token</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">query</span>
    <span class="k">global</span> <span class="n">_oauth_state</span>
    <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_oauth_state</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">_oauth_state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">or</span> <span class="s2">&quot;code&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># idk man, not much you can do</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>

    <span class="n">form</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
        <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_secret</span><span class="p">,</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
        <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
        <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/twitch/receive-token&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>

    <span class="n">enc</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://id.twitch.tv/oauth2/token?</span><span class="si">{</span><span class="n">enc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-oauth&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-refresh&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">])</span>

    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">TConn</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Handshake successful! You may now close this tab.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_oauth_token">
<a class="viewcode-back" href="../../server.html#src.server.get_oauth_token">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_oauth_token</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-oauth&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-oauth&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">getfile</span><span class="p">(</span><span class="s2">&quot;twitch-refresh&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Twitch_startup">
<a class="viewcode-back" href="../../server.html#src.server.Twitch_startup">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">Twitch_startup</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">TConn</span>

    <span class="n">TConn</span> <span class="o">=</span> <span class="n">TwitchConn</span><span class="p">(</span>
        <span class="n">token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">oauth_token</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
        <span class="n">initial_channels</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">channel</span><span class="p">],</span>
        <span class="n">case_insensitive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">TConn</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_id</span>
    <span class="n">TConn</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_secret</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">_to_add_twitch</span><span class="p">:</span>
        <span class="n">TConn</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">load</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">AppClient</span><span class="o">.</span><span class="n">from_client_credentials</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">twitch</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">client_secret</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_oauth_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="n">TConn</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="n">esbot</span> <span class="o">=</span> <span class="n">EventSubBot</span><span class="o">.</span><span class="n">from_client_credentials</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">websocket_client</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">websocket_client</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">TConn</span><span class="o">.</span><span class="n">esclient</span> <span class="o">=</span> <span class="n">EventSubClient</span><span class="p">(</span>
        <span class="n">esbot</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">webhook</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">/eventsub&quot;</span>
    <span class="p">)</span>
    <span class="c1"># await TConn.eventsub_setup()</span>

    <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span></div>



<div class="viewcode-block" id="Twitch_cleanup">
<a class="viewcode-back" href="../../server.html#src.server.Twitch_cleanup">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">Twitch_cleanup</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">TConn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="Discord_startup">
<a class="viewcode-back" href="../../server.html#src.server.Discord_startup">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">Discord_startup</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">DConn</span>
    <span class="n">DConn</span> <span class="o">=</span> <span class="n">DiscordConn</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
        <span class="n">case_insensitive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">owner_ids</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">discord</span><span class="o">.</span><span class="n">owners</span><span class="p">,</span>
        <span class="n">help_command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">intents</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Intents</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">_to_add_discord</span><span class="p">:</span>
        <span class="n">DConn</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">DConn</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">discord</span><span class="o">.</span><span class="n">oauth_token</span><span class="p">)</span></div>



<div class="viewcode-block" id="Discord_cleanup">
<a class="viewcode-back" href="../../server.html#src.server.Discord_cleanup">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">Discord_cleanup</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">DConn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="Youtube_startup">
<a class="viewcode-back" href="../../server.html#src.server.Youtube_startup">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">Youtube_startup</span><span class="p">():</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">TConn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">TConn</span><span class="o">.</span><span class="n">_session</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Youtube playlist sheet download. Will refresh every </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">s.&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">youtube</span><span class="o">.</span><span class="n">playlist_sheet</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="n">prev</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span> <span class="c1"># no need to update anything (or nothing to update)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="c1"># We&#39;re using DictReader with a defined set of fields so that if any keys are added to</span>
            <span class="c1"># the sheet the display code here won&#39;t break.</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Game&quot;</span><span class="p">,</span> <span class="s2">&quot;Youtube Link&quot;</span><span class="p">,</span> <span class="s2">&quot;Origin&quot;</span><span class="p">,</span> <span class="s2">&quot;Steam Link&quot;</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="c1"># Skip the header line (needed when setting fieldnames)</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="c1"># Serialize from a special object down to a pure list so we can json dump later</span>
            <span class="n">playlists</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">playlists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">text</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span></div>


<div class="viewcode-block" id="Archive_startup">
<a class="viewcode-back" href="../../server.html#src.server.Archive_startup">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">Archive_startup</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching YouTube Archive run information.&quot;</span><span class="p">)</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">load_from_disk</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">load_from_api</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to fetch archive data.&quot;</span><span class="p">)</span>
        <span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">determine_offset</span><span class="p">()</span>
        <span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">write_to_disk</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">youtube</span><span class="o">.</span><span class="n">cache_timeout</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2022-2025, Anilyka Barry, Olivia Thiderman, Spireblight Development Team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>